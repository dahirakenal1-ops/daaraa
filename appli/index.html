<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Dahira Kenal">
    <meta name="description" content="Syst√®me de gestion des membres et cotisations du Dahira Kenal">
    <meta name="theme-color" content="#059669">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Apple iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dahira Kenal">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23059669' /%3E%3Cstop offset='100%25' style='stop-color:%230d9488' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23grad)' width='180' height='180' rx='40'/%3E%3Ctext x='90' y='125' font-size='90' text-anchor='middle' fill='white'%3Eüïå%3C/text%3E%3C/svg%3E">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#059669">
    <meta name="msapplication-tap-highlight" content="no">
    
    <title>Dahira Kenal</title>
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ecfdf5 0%, #ccfbf1 100%);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
            padding-bottom: calc(70px + var(--safe-area-bottom));
        }

        .header {
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            color: white;
            padding: max(1rem, env(safe-area-inset-top)) 1.5rem 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            font-weight: 700;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
        }

        .tabs {
            display: none !important; /* Masqu√© par d√©faut sur mobile - FORC√â */
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            background: #f3f4f6;
        }

        .tab.active {
            color: white;
            background: #059669;
            border-bottom-color: #047857;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .btn-primary {
            background: #059669;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #047857;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #d1d5db;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #9ca3af;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.3rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .member-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .member-card:hover {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .member-name {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
        }

        .member-date {
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .status-ok {
            background: #d1fae5;
            color: #065f46;
        }

        .status-late {
            background: #fee2e2;
            color: #991b1b;
        }

        .member-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-icon {
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-call {
            background: #3b82f6;
            color: white;
        }

        .btn-whatsapp {
            background: #25d366;
            color: white;
        }

        .btn-edit {
            background: #f59e0b;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-print {
            background: #059669;
            color: white;
        }

        .btn-history {
            background: #6366f1;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem 1rem 0 0;
            position: relative;
        }

        .modal-header h3 {
            font-size: 1.5rem;
        }

        .btn-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #059669;
        }

        .field-error {
            color: #dc2626;
            font-size: 0.9rem;
            margin-top: 0.25rem;
            display: block;
        }

        .input-invalid {
            border-color: #dc2626 !important;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stats-card {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stats-card h3 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .stats-card .big-number {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .payment-table {
            width: 100%;
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .payment-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-table th {
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .payment-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .payment-table tr:nth-child(even) {
            background: #f9fafb;
        }

        .payment-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .type-hebdo {
            background: #d1fae5;
            color: #065f46;
        }

        .type-mensuel {
            background: #ccfbf1;
            color: #115e59;
        }

        .type-social {
            background: #fde68a;
            color: #92400e;
        }

        .type-diayante {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .type-event {
            background: #e9d5ff;
            color: #7c3aed;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-actions h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .backup-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .btn-export,
        .btn-import {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-export:hover,
        .btn-import:hover {
            background: #2563eb;
        }

        /* Sync status badge */
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.6rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }

        .sync-status.idle {
            background: rgba(17, 24, 39, 0.6);
        }

        .sync-status.syncing {
            background: #2563eb;
        }

        .sync-status.success {
            background: #059669;
        }

        .sync-status.error {
            background: #dc2626;
        }

        .sync-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .stat-value {
            font-size: 1.125rem;
            font-weight: bold;
            color: #059669;
            margin-top: 0.25rem;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .print-area,
            .print-area * {
                visibility: visible;
            }

            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .no-print {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .tabs {
                overflow-x: auto;
            }

            .tab {
                min-width: 120px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .member-actions {
                justify-content: center;
            }
        }

        /* Styles pour la carte de membre */
        .member-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            padding: 1rem 0;
        }

        .member-card-digital {
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .member-card-digital.large {
            max-width: 500px;
            margin: 0 auto;
            padding: 3rem;
            font-size: 1.2rem;
        }

        .member-card-digital.large .card-photo img {
            width: 150px;
            height: 150px;
        }

        .member-card-digital.large .card-info h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .member-card-digital.large .card-stats {
            margin: 2rem 0;
        }

        .member-card-digital.large .card-qr {
            margin: 2rem 0;
        }

        .member-card-digital::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(-10%, -10%);
            }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .card-logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .card-id {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .card-photo-section {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .card-photo-wrapper {
            position: relative;
        }

        .card-photo {
            width: 120px;
            height: 120px;
            border-radius: 0.75rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .card-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .card-date {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .card-qr-section {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .card-qr-code {
            display: block;
        }

        .card-actions {
            display: flex;
            gap: 0.75rem;
            position: relative;
            z-index: 1;
        }

        .card-action-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .card-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .card-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .card-modal.active {
            display: flex;
        }

        .card-modal-content {
            max-width: 600px;
            width: 100%;
            position: relative;
        }

        .card-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: white;
            color: #1f2937;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .card-modal-close:hover {
            background: #f3f4f6;
            transform: rotate(90deg);
        }

        /* Bulk Reminder Styles */
        .reminder-box {
            background: #fff7ed;
            border: 1px solid #fdba74;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .reminder-textarea {
            width: 100%;
            height: 150px;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* --- MODE SOMBRE (Dark Mode) --- */
        body.dark-mode {
            background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
            color: #e5e7eb;
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            color: white;
        }

        body.dark-mode .tabs {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }

        body.dark-mode .tab {
            color: #9ca3af;
        }

        body.dark-mode .tab.active {
            background: #059669;
            color: white;
        }

        body.dark-mode .member-card,
        body.dark-mode .kpi-card,
        body.dark-mode .chart-card,
        body.dark-mode .metric-card,
        body.dark-mode .stats-card,
        body.dark-mode .modal-content,
        body.dark-mode .payment-table,
        body.dark-mode .dashboard-metrics,
        body.dark-mode .dashboard-charts .chart-card {
            background: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
        }

        body.dark-mode .member-name,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode th,
        body.dark-mode strong {
            color: white;
        }

        body.dark-mode .member-date,
        body.dark-mode .stat-label,
        body.dark-mode p,
        body.dark-mode td,
        body.dark-mode .header p {
            color: #9ca3af;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #374151;
            border: 2px solid #4b5563;
            color: white;
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus {
            border-color: #059669;
            background: #4b5563;
        }

        body.dark-mode .payment-table th {
            background: #064e3b;
            /* Vert plus sombre */
        }

        body.dark-mode .payment-table tr:nth-child(even) {
            background: #1f2937;
        }

        body.dark-mode .btn-secondary {
            background: #4b5563;
            color: white;
        }

        body.dark-mode .btn-secondary:hover {
            background: #6b7280;
        }

        body.dark-mode .field-error {
            color: #f87171;
        }

        /* Bottom nav TOUJOURS blanche (m√™me en dark mode) */
        body.dark-mode .bottom-nav {
            background: white !important;
            border-top: 1px solid #e2e8f0;
        }

        body.dark-mode .nav-item {
            color: #64748b;
        }

        body.dark-mode .nav-item.active {
            color: #059669;
        }

        /* --- MODULE √âV√âNEMENTS --- */
        #events-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .evt-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #059669;
            transition: transform 0.2s;
        }

        .evt-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .evt-card.past {
            border-left-color: #9ca3af;
            opacity: 0.7;
        }

        .evt-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .evt-date {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 1rem;
            background: #f3f4f6;
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .evt-desc {
            color: #4b5563;
            margin-bottom: 1rem;
        }

        .evt-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .evt-fee {
            font-weight: bold;
            color: #059669;
        }

        .evt-actions {
            display: flex;
            gap: 0.5rem;
        }

        .evt-btn {
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: white;
        }

        .evt-btn-edit {
            background: #3b82f6;
        }

        .evt-btn-delete {
            background: #ef4444;
        }

        /* Modale √âv√©nement */
        #evt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #evt-modal.active {
            display: flex;
        }

        .evt-modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 1rem;
            padding: 2rem;
            animation: slideIn 0.3s;
        }

        .evt-form-group {
            margin-bottom: 1rem;
        }

        .evt-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }

        .evt-btn-primary {
            width: 100%;
            background: #059669;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ===== STYLES MOBILE NATIFS ===== */
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: flex-start;
            padding: 8px 0 calc(8px + var(--safe-area-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            z-index: 100;
            border-top: 1px solid #e2e8f0;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        .bottom-nav::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }

        /* Effet de fade sur les c√¥t√©s pour indiquer le scroll */
        .bottom-nav::before,
        .bottom-nav::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: calc(var(--safe-area-bottom));
            width: 40px;
            pointer-events: none;
            z-index: 1;
        }

        .bottom-nav::before {
            left: 0;
            background: linear-gradient(to right, white, transparent);
        }

        .bottom-nav::after {
            right: 0;
            background: linear-gradient(to left, white, transparent);
        }

        .nav-item {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            border: none;
            background: none;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-width: 70px;
            white-space: nowrap;
        }

        .nav-item i {
            font-size: 1.35rem;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            width: 40px;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 3px 3px;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: calc(80px + var(--safe-area-bottom));
            right: 1rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, #10b981 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s;
            z-index: 90;
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: calc(80px + var(--safe-area-bottom));
            left: 1rem;
            right: 1rem;
            background: #1e293b;
            color: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.show {
            transform: translateY(0);
        }

        /* Optimisations boutons pour tactile */
        .btn-primary,
        .btn-secondary,
        .btn-icon {
            min-height: 48px;
            min-width: 48px;
        }

        .btn-primary:active,
        .btn-secondary:active,
        .btn-icon:active {
            transform: scale(0.98);
        }

        /* Afficher les tabs desktop sur grand √©cran */
        @media (min-width: 768px) {
            .tabs {
                display: flex !important; /* Afficher les tabs sur desktop - FORC√â */
            }
            .bottom-nav {
                display: none;
            }
            .fab {
                display: none;
            }
            body {
                padding-bottom: 0;
            }
        }

        /* ===== STYLES PWA MODE ===== */
        
        /* Mode PWA standalone - exp√©rience plein √©cran */
        body.pwa-mode {
            overscroll-behavior: contain;
            -webkit-user-select: none;
            user-select: none;
        }

        body.pwa-mode .header {
            -webkit-app-region: drag; /* Permet de bouger l'app en PWA desktop */
        }

        /* iOS PWA - masquer la barre de statut */
        body.ios-pwa {
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
        }

        /* Splash screen custom (optionnel) */
        @media (display-mode: standalone) {
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeOut 0.5s ease-out 0.5s forwards;
                pointer-events: none;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        /* Am√©lioration du pull-to-refresh natif */
        html {
            overscroll-behavior-y: contain;
        }

        /* Emp√™cher le zoom sur les inputs (iOS) */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            select,
            textarea,
            input {
                font-size: 16px !important;
            }
        }

        /* Mode plein √©cran sans barre de statut */
        @media (display-mode: fullscreen) {
            body {
                padding-top: 0;
            }
            
            .header {
                padding-top: 1rem;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üïå Dahira Kenal</h1>
        <p>Syst√®me de Gestion des Membres et Cotisations DKST (Optimis√©)</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('membres', event)">üë• Membres</button>
        <button class="tab" onclick="showTab('dashboard', event)">üìä Dashboard</button>
        <button class="tab" onclick="showTab('paiements', event)">üí∞ Cotisations</button>
        <button class="tab" onclick="showTab('stats', event)">üìà Statistiques</button>
        <button class="tab" onclick="showTab('rapports', event)">üìÑ Rapports</button>
        <button class="tab" onclick="showTab('depenses', event)">üí∏ D√©penses</button>
        <button class="tab" onclick="showTab('evenements', event)">üìÖ √âv√©nements</button>
        <button class="tab" onclick="showTab('carte', event)">üí≥ Carte</button>
        <button class="tab" onclick="showTab('calculateur', event)">üßÆ Calculateur</button>
    </div>

    <div class="container">
        <div class="backup-buttons no-print">
            <button class="btn-export" onclick="exportData()">üì• Export</button>
            <button class="btn-import" onclick="document.getElementById('import-file').click()">üì§ Importer</button>
            <button class="btn-secondary" onclick="openVersions()">üïò Versions</button>
            <button class="btn-secondary" id="btn-theme" onclick="toggleDarkMode()">üåô Mode Sombre</button>
            <button class="btn-secondary" id="btn-open-auth" onclick="openAuth()">üîê Connexion au donner</button>
            <button class="btn-primary" id="btn-cloud-save" onclick="cloudSaveAll()">‚òÅÔ∏è Sync vers le cloud</button>
            <button class="btn-secondary" id="btn-cloud-load" onclick="cloudLoadAll()">‚¨áÔ∏è Importer depuis le
                cloud</button>
            <div id="sync-status" class="sync-status idle" style="margin-left:0.5rem;">‚è∫Ô∏è Idle</div>
            <input type="file" id="import-file" accept=".json" onchange="importData(event)" style="display: none;">
        </div>


        <div id="tab-membres" class="tab-content active">
            <div class="header-actions">
                <h2>Liste des Membres (<span id="membre-count">0</span>)</h2>
                <button class="btn-primary" onclick="openModal('addMember')">+ Nouveau Membre</button>
            </div>
            <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <input type="text" id="search-input" placeholder="Rechercher..." class="form-input"
                    style="flex: 1; min-width: 200px;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="filter-ok" checked> √Ä jour
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="filter-late" checked> En retard
                </label>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span style="font-weight: 500; color: #374151;">Sexe:</span>
                    <label style="display: flex; align-items: center; gap: 0.25rem;">
                        <input type="radio" name="filter-sexe" value="" checked> Tous
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.25rem;">
                        <input type="radio" name="filter-sexe" value="M"> Hommes
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.25rem;">
                        <input type="radio" name="filter-sexe" value="F"> Femmes
                    </label>
                </div>
            </div>
            <div id="membres-list"></div>
        </div>


        <!-- ONGLET DASHBOARD -->
        <div id="tab-dashboard" class="tab-content">
            <h2 style="margin-bottom: 2rem;">üìä Dashboard - Vue d'ensemble</h2>

            <!-- Bouton Relance -->
            <div style="margin-bottom: 1.5rem; text-align: right;">
                <button class="btn-primary" onclick="generateBulkReminder()">üì¢ Relancer les retardataires
                    (WhatsApp)</button>
            </div>

            <!-- Zone d'affichage de la relanche -->
            <div id="bulk-reminder-area" style="display:none;" class="reminder-box">
                <h3>üìã Message de Relance Copier-Coller</h3>
                <p style="font-size: 0.9rem; color: #666;">Copiez ce texte et collez-le dans votre groupe WhatsApp.</p>
                <textarea id="reminder-text" class="reminder-textarea" readonly></textarea>
                <div style="margin-top: 0.5rem;">
                    <button class="btn-primary" onclick="copyToClipboard()">üìã Copier le texte</button>
                    <button class="btn-secondary"
                        onclick="document.getElementById('bulk-reminder-area').style.display='none'">Fermer</button>
                </div>
            </div>

            <!-- M√©triques principales -->
            <div class="dashboard-metrics"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="metric-card"
                    style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">Total Membres</h3>
                    <p style="font-size: 2rem; font-weight: bold; margin: 0;" id="dashboard-total-membres">0</p>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">
                        <span id="dashboard-nouveaux-membres">0</span> nouveaux ce mois
                    </div>
                </div>
                <div class="metric-card"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">Cotisations du Mois</h3>
                    <p style="font-size: 2rem; font-weight: bold; margin: 0;" id="dashboard-cotisations-mois">0 FCFA</p>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">
                        <span id="dashboard-cotisations-annee">0</span> FCFA cette ann√©e
                    </div>
                </div>
                <div class="metric-card"
                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">D√©penses du Mois</h3>
                    <p style="font-size: 2rem; font-weight: bold; margin: 0;" id="dashboard-depenses-mois">0 FCFA</p>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">
                        <span id="dashboard-ratio-depenses">0</span>% du budget
                    </div>
                </div>
                <div class="metric-card"
                    style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">Solde</h3>
                    <p style="font-size: 2rem; font-weight: bold; margin: 0;" id="dashboard-solde">0 FCFA</p>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">
                        <span id="dashboard-solde-trend" style="color: #10b981;">‚ÜóÔ∏è +0%</span> vs mois dernier
                    </div>
                </div>
            </div>

            <!-- KPIs suppl√©mentaires -->
            <div class="dashboard-kpis"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="kpi-card"
                    style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #059669;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Taux des ADIYA</p>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #059669; margin: 0;"
                                id="kpi-taux-paiement">0%</p>
                        </div>
                        <div style="font-size: 2rem;">üìä</div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span style="font-size: 0.75rem; color: #059669;" id="kpi-membres-ajour">0</span> membres √† jour
                    </div>
                </div>

                <div class="kpi-card"
                    style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #3b82f6;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Moyenne/Membre</p>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #3b82f6; margin: 0;"
                                id="kpi-moyenne-membre">0 FCFA</p>
                        </div>
                        <div style="font-size: 2rem;">üë•</div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span style="font-size: 0.75rem; color: #3b82f6;">Cotisation moyenne</span>
                    </div>
                </div>

                <div class="kpi-card"
                    style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #f59e0b;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Croissance</p>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #f59e0b; margin: 0;"
                                id="kpi-croissance">+0%</p>
                        </div>
                        <div style="font-size: 2rem;">üìà</div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span style="font-size: 0.75rem; color: #f59e0b;">Nouveaux membres</span>
                    </div>
                </div>

                <div class="kpi-card"
                    style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #7c3aed;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Activit√©</p>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #7c3aed; margin: 0;"
                                id="kpi-activite">0%</p>
                        </div>
                        <div style="font-size: 2rem;">‚ö°</div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span style="font-size: 0.75rem; color: #7c3aed;">Membres actifs</span>
                    </div>
                </div>

                <div class="kpi-card"
                    style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #ec4899;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">√âquilibre</p>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #ec4899; margin: 0;"
                                id="kpi-equilibre">0%</p>
                        </div>
                        <div style="font-size: 2rem;">‚öñÔ∏è</div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span style="font-size: 0.75rem; color: #ec4899;">Ratio D√©p./Rec.</span>
                    </div>
                </div>

                <div class="kpi-card"
                    style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #059669;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Performance</p>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #059669; margin: 0;"
                                id="kpi-performance">0%</p>
                        </div>
                        <div style="font-size: 2rem;">üéØ</div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span style="font-size: 0.75rem; color: #059669;">Objectif mensuel</span>
                    </div>
                </div>
            </div>

            <!-- Graphiques -->
            <div class="dashboard-charts"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">

                <!-- R√©partition par sexe -->
                <div class="chart-card"
                    style="background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1.5rem; color: #1f2937;">R√©partition par Sexe</h3>
                    <canvas id="chart-sexe" width="300" height="300"></canvas>
                </div>

                <!-- √âvolution des membres -->
                <div class="chart-card"
                    style="background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1.5rem; color: #1f2937;">√âvolution des Membres</h3>
                    <canvas id="chart-evolution" width="300" height="300"></canvas>
                </div>

                <!-- Paiements par caisse -->
                <div class="chart-card"
                    style="background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1.5rem; color: #1f2937;">ADIYA par Caisse (6 derniers mois)</h3>
                    <canvas id="chart-paiements-caisse" width="300" height="300"></canvas>
                </div>

                <!-- Statut des paiements -->
                <div class="chart-card"
                    style="background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1.5rem; color: #1f2937;">Statut des ADIYA</h3>
                    <canvas id="chart-statut-paiements" width="300" height="300"></canvas>
                </div>

                <!-- D√©penses par caisse -->
                <div class="chart-card"
                    style="background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1.5rem; color: #1f2937;">D√©penses par Caisse (6 derniers mois)</h3>
                    <canvas id="chart-depenses-caisse" width="300" height="300"></canvas>
                </div>

                <!-- Top contributeurs -->
                <div class="chart-card"
                    style="background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1.5rem; color: #1f2937;">Top 5 Contributeurs</h3>
                    <canvas id="chart-top-contributeurs" width="300" height="300"></canvas>
                </div>
            </div>
        </div>


        <div id="tab-paiements" class="tab-content">
            <div class="header-actions">
                <h2>Historique des ADIYA (<span id="payment-count">0</span>)</h2>
            </div>
            <div class="payment-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Membre</th>
                            <th>Type</th>
                            <th>M√©thode</th>
                            <th style="text-align: right;">Montant</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payments-list"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-depenses" class="tab-content">
            <div class="header-actions">
                <h2>D√©penses (<span id="expense-count">0</span>)</h2>
                <button class="btn-primary" onclick="openExpenseModal()">+ Nouvelle D√©pense</button>
            </div>
            <div class="payment-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Libell√©</th>
                            <th>Caisse</th>
                            <th style="text-align: right;">Montant</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-list"></tbody>
                </table>
            </div>
        </div>


        <div id="tab-stats" class="tab-content">
            <h2 style="margin-bottom: 1.5rem;">Statistiques Globales</h2>
            <div class="stats-cards">
                <div class="stats-card">
                    <h3>Caisse Hebdomadaire</h3>
                    <p class="big-number" id="total-hebdo">0</p>
                    <p style="opacity: 0.8;">FCFA</p>
                    <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: <span
                            id="expense-hebdo">0</span> FCFA</p>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);">
                    <h3>Caisse Mensuelle</h3>
                    <p class="big-number" id="total-mensuel">0</p>
                    <p style="opacity: 0.8;">FCFA</p>
                    <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: <span
                            id="expense-mensuel">0</span> FCFA</p>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <h3>Caisse Sociale</h3>
                    <p class="big-number" id="total-social">0</p>
                    <p style="opacity: 0.8;">FCFA</p>
                    <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: <span
                            id="expense-social">0</span> FCFA</p>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">
                    <h3>Caisse Diayante</h3>
                    <p class="big-number" id="total-diayante">0</p>
                    <p style="opacity: 0.8;">FCFA</p>
                    <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: <span
                            id="expense-diayante">0</span> FCFA</p>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <h3>Total D√©penses</h3>
                    <p class="big-number" id="total-expenses">0</p>
                    <p style="opacity: 0.8;">FCFA</p>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%);">
                    <h3>Total Global</h3>
                    <p class="big-number" id="total-global">0</p>
                    <p style="opacity: 0.8;">FCFA</p>
                </div>
            </div>
            <div id="stats-details"></div>
        </div>


        <div id="tab-rapports" class="tab-content">
            <h2 style="margin-bottom: 1.5rem;">Rapports et Comptes Rendus</h2>

            <div class="member-card">
                <h3 style="margin-bottom: 1rem;">P√©riode du Rapport</h3>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Date de d√©but</label>
                        <input type="date" id="rapport-start" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date de fin</label>
                        <input type="date" id="rapport-end" class="form-input">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="generateRapportHebdo()">üìÑ Rapport Hebdomadaire</button>
                    <button class="btn-primary" onclick="generateRapportMensuel()">üìÑ Rapport Mensuel</button>
                    <button class="btn-primary" onclick="generateRapportSocial()">üìÑ Rapport Social</button>
                    <button class="btn-primary" onclick="generateRapportDiayante()">üìÑ Rapport Diayante</button>
                    <button class="btn-primary" onclick="generateRapportDepenses()">üìÑ Rapport D√©penses</button>
                    <button class="btn-primary" onclick="generateRapportGlobal()">üìÑ Rapport Global</button>
                    <button class="btn-primary" onclick="generateRapportHommes()">üë® Rapport Hommes</button>
                    <button class="btn-primary" onclick="generateRapportFemmes()">üë© Rapport Femmes</button>
                    <button class="btn-primary" onclick="generateRapportTousMembres()">üë• Rapport Tous Membres</button>
                </div>
                <div id="event-reports-buttons" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;"></div>
            </div>

            <div id="rapport-preview" style="display: none;" class="member-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Aper√ßu du Rapport</h3>
                    <button class="btn-primary" onclick="printRapport()">üñ®Ô∏è Imprimer</button>
                </div>
                <div id="rapport-content"></div>
            </div>
        </div>


        <div id="tab-calculateur" class="tab-content">
            <h2 style="margin-bottom: 2rem;">Calculateur de Cotisations</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                <div class="member-card">
                    <h3 style="margin-bottom: 1rem;">Calculateur Individuel</h3>
                    <div class="form-group">
                        <label class="form-label">Membre</label>
                        <select id="calc-member" class="form-select" onchange="calculateIndividual()">
                            <option value="">S√©lectionner...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">P√©riode (mois)</label>
                        <input type="number" id="calc-period" class="form-input" value="1" min="1"
                            onchange="calculateIndividual()">
                    </div>
                    <div id="calc-result"
                        style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;"></div>
                </div>
                <div class="member-card">
                    <h3 style="margin-bottom: 1rem;">Calculateur Global</h3>
                    <div class="form-group">
                        <label class="form-label">Nombre de membres</label>
                        <input type="number" id="calc-total" class="form-input" value="10" min="1"
                            onchange="calculateGlobal()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">P√©riode (mois)</label>
                        <input type="number" id="calc-global-period" class="form-input" value="1" min="1"
                            onchange="calculateGlobal()">
                    </div>
                    <div id="calc-global-result"
                        style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;"></div>
                </div>
            </div>
        </div>


        <!-- ONGLET CARTE -->
        <div id="tab-carte" class="tab-content">
            <h2 style="margin-bottom: 2rem;">Cartes de Membre</h2>

            <!-- Barre de recherche -->
            <div class="search-container" style="margin-bottom: 2rem;">
                <div class="form-group" style="max-width: 400px;">
                    <label class="form-label">üîç Rechercher un membre</label>
                    <input type="text" id="carte-search-input" class="form-input"
                        placeholder="Tapez le nom ou pr√©nom..." style="padding: 0.75rem 1rem;">
                </div>
            </div>

            <div id="carte-list" class="member-card-container">
                <!-- Les cartes seront g√©n√©r√©es ici -->
            </div>

        </div>
        <!-- ONGLET √âV√âNEMENTS -->
        <div id="tab-evenements" class="tab-content">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <h2>Gestion des √âv√©nements</h2>
                <button class="btn-primary" onclick="eventsModule.openModal()">‚ûï Nouvel √âv√©nement</button>
            </div>

            <div id="events-container">
                <!-- Les cartes s'afficheront ici automatiquement -->
            </div>
        </div>
    </div>


    <div id="modal-membre" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-membre-title">Nouveau Membre</h3>
                <button class="btn-close" onclick="closeModal('modal-membre')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nom</label>
                    <input type="text" id="membre-nom" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Pr√©nom</label>
                    <input type="text" id="membre-prenom" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Sexe</label>
                    <select id="membre-sexe" class="form-select">
                        <option value="M">Masculin</option>
                        <option value="F">F√©minin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">T√©l√©phone <small
                            style="color: #6b7280; font-weight: normal;">(facultatif)</small></label>
                    <input type="tel" id="membre-tel" class="form-input" placeholder="77 123 45 67" maxlength="15">
                    <small id="membre-tel-error" class="field-error" style="display:none;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Email <small
                            style="color: #6b7280; font-weight: normal;">(facultatif)</small></label>
                    <input type="email" id="membre-email" class="form-input" placeholder="exemple@mail.com">
                    <small id="membre-email-error" class="field-error" style="display:none;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Date d'adh√©sion</label>
                    <input type="date" id="membre-date" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie d'√¢ge</label>
                    <select id="membre-categorie-age" class="form-select">
                        <option value="enfant">Enfant</option>
                        <option value="adulte" selected>Adulte</option>
                        <option value="3eme-age">3√®me √¢ge</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">R√¥les dans le Dahira <small style="color: #6b7280; font-weight: normal;">(cochez tous ceux qui s'appliquent)</small></label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="role-simple" value="membre-simple" style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
                            <span>Membre Simple</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="role-finance" value="membre-finance" style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
                            <span>Membre Finance</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="role-bureau" value="membre-bureau" style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
                            <span>Membre Bureau</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="role-audiovisuel" value="membre-audiovisuel" style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
                            <span>Membre Audio-Visuel</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="role-culturel" value="membre-culturel" style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
                            <span>Membre Culturel</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="role-kourel" value="membre-kourel" style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
                            <span>Membre Kourel</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="role-organisation" value="membre-organisation" style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
                            <span>Membre Organisation</span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" style="flex: 1;" onclick="saveMembre()">Enregistrer</button>
                    <button class="btn-secondary" onclick="closeModal('modal-membre')">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-auth" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Connexion Firebase</h3>
                <button class="btn-close" onclick="closeModal('modal-auth')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="auth-email" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe</label>
                    <input type="password" id="auth-password" class="form-input">
                </div>
                <div style="display:flex; gap:0.5rem;">
                    <button class="btn-primary" onclick="signInFirebase()">Se connecter</button>
                    <button class="btn-secondary" onclick="signUpFirebase()" disabled>Cr√©er un compte</button>
                    <button class="btn-secondary" onclick="signOutFirebase()">Se d√©connecter</button>
                </div>
                <p style="margin-top:1rem; color:#6b7280; font-size:0.9rem;">Remarque: fournissez la configuration
                    Firebase dans la variable globale <strong>FIREBASE_CONFIG</strong> (voir commentaires dans le code).
                </p>
            </div>
        </div>
    </div>


    <div id="modal-paiement" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ajouter un ADIYA</h3>
                <button class="btn-close" onclick="closeModal('modal-paiement')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Type de caisse</label>
                    <select id="payment-type" class="form-select" onchange="updatePaymentAmount()">
                        <option value="hebdomadaire">Hebdomadaire (250 FCFA)</option>
                        <option value="mensuelle">Mensuelle (500 FCFA)</option>
                        <option value="social">Caisse sociale (500 FCFA)</option>
                        <option value="diayante">Diayante (10000 FCFA)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (FCFA)</label>
                    <input type="number" id="payment-montant" class="form-input" value="250">
                    <small id="payment-montant-error" class="field-error" style="display:none;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="payment-date" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">M√©thode de paiement</label>
                    <select id="payment-methode" class="form-select">
                        <option value="esp√®ces">Esp√®ces</option>
                        <option value="wave">Wave</option>
                        <option value="orange-money">Orange Money</option>
                    </select>
                </div>
                <button class="btn-primary" style="flex: 1;" onclick="savePayment()">Enregistrer</button>
                <button class="btn-secondary" onclick="closeModal('modal-paiement')">Annuler</button>
            </div>
        </div>
    </div>

    <div id="modal-depense" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nouvelle D√©pense</h3>
                <button class="btn-close" onclick="closeModal('modal-depense')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Libell√©</label>
                    <input type="text" id="expense-label" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (FCFA)</label>
                    <input type="number" id="expense-montant" class="form-input" value="0">
                    <small id="expense-montant-error" class="field-error" style="display:none;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Caisse</label>
                    <select id="expense-caisse" class="form-select">
                        <option value="hebdomadaire">Hebdomadaire</option>
                        <option value="mensuelle">Mensuelle</option>
                        <option value="social">Sociale</option>
                        <option value="diayante">Diayante</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="expense-date" class="form-input">
                </div>
                <div class="form-actions">
                    <button class="btn-primary" style="flex: 1;" onclick="saveExpense()">Enregistrer</button>
                    <button class="btn-secondary" onclick="closeModal('modal-depense')">Annuler</button>
                </div>
            </div>
        </div>
    </div>


    <div id="print-area" class="print-area" style="display: none;"></div>

    <div id="modal-versions" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Sauvegardes & Versions</h3>
                <button class="btn-close" onclick="closeModal('modal-versions')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="versions-list">Aucune version encore</div>
                <div style="margin-top:2rem; border-top:1px solid #eee; padding-top:1rem;">
                    <h4 style="color:#dc2626; margin-bottom:0.5rem;">Zone Dangereuse</h4>
                    <button class="btn-danger" onclick="resetAllData()">‚ö†Ô∏è R√©initialiser l'application</button>
                </div>
                <div style="margin-top:1rem; display:flex; gap:0.5rem; justify-content:flex-end;">
                    <button class="btn-secondary" onclick="closeModal('modal-versions')">Fermer</button>
                </div>
            </div>
        </div>
    </div>
    <footer
        style="background: linear-gradient(135deg, #1f2937 0%, #374151 100%); color: white; padding: 2rem 0; margin-top: 3rem; text-align: center;">
        <p style="margin: 0; font-size: 1rem; font-weight: 500;">¬© Copyright 2026 . Made by ABDOULAHI DIALLO</p>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; opacity: 0.8;"> Pour toute demande de modification,
            veuillez me contacter</p>
        <a href="https://wa.me/221761808410?text=As-salamou aleykoum, j'ai une demande de modification pour l'application Dahira Kenal"
            target="_blank"
            style="display: inline-block; margin-top: 1rem; padding: 0.75rem 1.5rem; background: #25d366; color: white; text-decoration: none; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s;">
            üí¨WhatsApp
        </a>
    </footer>


    <!-- Firebase configuration fournie par l'utilisateur -->
    <script>
        window.FIREBASE_CONFIG = {
            apiKey: "AIzaSyBkcnXxfcw4TN3DSmtUeimJ5br7PuBpqVo",
            authDomain: "dahira-kenal.firebaseapp.com",
            databaseURL: "https://dahira-kenal-default-rtdb.firebaseio.com",
            projectId: "dahira-kenal",
            storageBucket: "dahira-kenal.firebasestorage.app",
            messagingSenderId: "363618938352",
            appId: "1:363618938352:web:307a7e87a9571cf08d4135",
            measurementId: "G-MD6F2PKZZY"
        };
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // --- MODULE √âV√âNEMENTS (LOGIQUE) ---
        // D√©fini en premier pour √™tre disponible partout
        const eventsModule = (function() {
            let eventsData = [];
            const STORAGE_KEY = 'dk_events';

            // 1. Chargement
            function init() {
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    eventsData = stored ? JSON.parse(stored) : [];
                    console.log('[Events] Module charg√© :', eventsData.length, '√©v√©nements');
                } catch (e) {
                    console.error('[Events] Erreur chargement', e);
                    eventsData = [];
                }
            }

            function save() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(eventsData));
                render(); // Mise √† jour de l'affichage
            }

            // 2. Rendu (Affichage des cartes)
            function render() {
                const container = document.getElementById('events-container');
                if (!container) return;

                const sorted = [...eventsData].sort((a, b) => new Date(a.date) - new Date(b.date));

                if (sorted.length === 0) {
                    container.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #6b7280;">Aucun √©v√©nement pr√©vu.</div>`;
                    return;
                }

                container.innerHTML = sorted.map(evt => {
                    const isPast = new Date(evt.date) < new Date();
                    const feeText = evt.fee > 0 ? `${evt.fee} FCFA` : 'Gratuit';
                    const feeColor = evt.fee > 0 ? 'var(--evt-primary)' : '#888';

                    return `
                    <div class="evt-card ${isPast ? 'past' : ''}" data-id="${evt.id}">
                        <div class="evt-title">${evt.title}</div>
                        <div class="evt-date">${new Date(evt.date).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        <div class="evt-desc">${evt.desc || ''}</div>
                        <div class="evt-footer">
                            <div class="evt-fee" style="color: ${feeColor}">${feeText}</div>
                            <div class="evt-actions">
                                <button class="evt-btn evt-btn-edit" onclick="eventsModule.openModal('${evt.id}')">‚úèÔ∏è Modifier</button>
                                <button class="evt-btn evt-btn-delete" onclick="eventsModule.del('${evt.id}')">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            // 3. Actions (Ouvrir modale, Sauvegarder, Supprimer)
            function openEventModal(id = null) {
                document.getElementById('evt-id').value = id || '';
                document.getElementById('evt-title').value = '';
                document.getElementById('evt-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('evt-desc').value = '';
                document.getElementById('evt-fee').value = '0';

                if (id) {
                    const evt = eventsData.find(e => e.id === id);
                    if (evt) {
                        document.getElementById('evt-title').value = evt.title;
                        document.getElementById('evt-date').value = evt.date;
                        document.getElementById('evt-desc').value = evt.desc;
                        document.getElementById('evt-fee').value = evt.fee;
                    }
                }
                document.getElementById('evt-modal').classList.add('active');
            }

            function closeEventModal() {
                document.getElementById('evt-modal').classList.remove('active');
            }

            function saveEvent() {
                const id = document.getElementById('evt-id').value;
                const title = document.getElementById('evt-title').value;
                const date = document.getElementById('evt-date').value;
                const desc = document.getElementById('evt-desc').value;
                const fee = parseInt(document.getElementById('evt-fee').value) || 0;

                if (!title || !date) {
                    showMessage('error', 'Le titre et la date sont obligatoires.');
                    return;
                }

                if (id) {
                    const index = eventsData.findIndex(e => e.id === id);
                    if (index !== -1) eventsData[index] = { id, title, date, desc, fee, caisse: eventsData[index].caisse };
                } else {
                    const newId = Date.now().toString();
                    const caisse = 'event-' + newId;
                    eventsData.push({ id: newId, title, date, desc, fee, caisse });
                }

                save();
                try { if (window.firebaseAuth && firebaseAuth.currentUser) cloudSaveAll(); } catch (e) { console.warn('cloudSaveAll error', e); }
                closeEventModal();
                showMessage('success', '√âv√©nement enregistr√© avec succ√®s !');
                // Mettre √† jour les statistiques apr√®s ajout/modification d'√©v√©nement
                if (window.updateStats) window.updateStats();
                if (window.renderDashboardCharts) window.renderDashboardCharts();
                if (window.updateEventReportsButtons) window.updateEventReportsButtons();
            }

            function del(id) {
                showConfirm('Voulez-vous vraiment supprimer cet √©v√©nement ?', () => {
                    eventsData = eventsData.filter(e => e.id !== id);
                    save();
                    // Mettre √† jour les statistiques apr√®s suppression d'√©v√©nement
                    if (window.updateStats) window.updateStats();
                    if (window.renderDashboardCharts) window.renderDashboardCharts();
                    if (window.updateEventReportsButtons) window.updateEventReportsButtons();
                });
            }

            // Initialisation et Exposition
            init();
            
            // On expose les fonctions n√©cessaires pour le HTML
            return {
                init,
                render,
                openModal: openEventModal,
                closeModal: closeEventModal,
                save: saveEvent,
                del,
                getEvents: () => eventsData
            };

        })();

        // Exposer le module globalement
        window.eventsModule = eventsModule;

        // --- FONCTIONS UTILES & UTILITAIRES ---

        // Helper Debounce pour optimiser la recherche (√©vite le lag)
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Initialize Firebase if FIREBASE_CONFIG provided
        function initFirebaseIfConfigured() {
            try {
                if (window.FIREBASE_CONFIG && !window.firebase.apps?.length) {
                    firebase.initializeApp(window.FIREBASE_CONFIG);
                    window.firebaseAuth = firebase.auth();
                    window.firebaseDb = firebase.database();
                    window.firebaseStorage = firebase.storage();
                    firebaseAuth.onAuthStateChanged(async user => {
                        if (user) {
                            setCurrentUser(user.email || user.uid);

                            // Import cloud data automatically on login
                            try {
                                if (!window.firebaseDb) {
                                    console.warn('Firebase DB non configur√©, import annul√©');
                                } else {
                                    const ref = firebaseDb.ref('users/' + user.uid);
                                    const snap = await ref.once('value');
                                    if (snap.exists()) {
                                        const data = snap.val() || {};
                                        membres = data.membres || [];
                                        payments = data.payments || [];
                                        expenses = data.expenses || [];
                                        safeSet('dahira-membres', membres);
                                        safeSet('dahira-payments', payments);
                                        safeSet('dahira-expenses', expenses);
                                        renderMembres();
                                        renderPayments();
                                        renderExpenses();
                                        showMessage('success', 'Donn√©es import√©es depuis le cloud');
                                        logAudit('auth_login_import', `Import cloud (user ${user.email || user.uid})`, null);
                                    } else {
                                        showMessage('warn', 'Aucune donn√©e cloud trouv√©e');
                                    }
                                }
                            } catch (err) {
                                console.warn('Import failed:', err);
                                showMessage('error', 'Erreur lors de l\'import: ' + (err.message || err));
                            }

                            showMessage('success', `Connect√© en tant que ${user.email || user.uid}`);
                            logAudit('auth-login', `Connexion Firebase: ${user.email || user.uid}`, null);
                        } else {
                            setCurrentUser('');
                        }
                    });
                }
            } catch (err) {
                console.warn('Firebase init error', err);
            }
        }
        initFirebaseIfConfigured();

        function openAuth() { document.getElementById('modal-auth').classList.add('active'); }

        async function signUpFirebase() {
            if (!window.firebaseAuth) { showMessage('error', 'Firebase non configur√©'); return; }
            const email = document.getElementById('auth-email').value.trim();
            const pwd = document.getElementById('auth-password').value;
            if (!email || !validateEmail(email)) { showMessage('error', 'Email invalide'); return; }
            if (!pwd || pwd.length < 6) { showMessage('error', 'Mot de passe invalide (min 6 caract√®res)'); return; }
            try {
                const res = await firebaseAuth.createUserWithEmailAndPassword(email, pwd);
                showMessage('success', 'Compte cr√©√©');
                logAudit('auth_signup', `Compte cr√©√©: ${email}`, null);
                console.info('Firebase signup result', res);
                closeModal('modal-auth');
            } catch (err) {
                console.error('Firebase signup error', err);
                showMessage('error', `${err.code || 'error'}: ${err.message}`);
            }
        }

        async function signInFirebase() {
            if (!window.firebaseAuth) { showMessage('error', 'Firebase non configur√©'); return; }
            const email = document.getElementById('auth-email').value.trim();
            const pwd = document.getElementById('auth-password').value;
            if (!email || !validateEmail(email)) { showMessage('error', 'Email invalide'); return; }
            if (!pwd) { showMessage('error', 'Entrez votre mot de passe'); return; }
            try {
                const res = await firebaseAuth.signInWithEmailAndPassword(email, pwd);
                showMessage('success', 'Connect√©');
                logAudit('auth_signin', `Connexion: ${email}`, null);
                console.info('Firebase signin result', res);
                closeModal('modal-auth');
            } catch (err) {
                console.error('Firebase signin error', err);
                showMessage('error', `${err.code || 'error'}: ${err.message}`);
            }
        }

        async function signOutFirebase() {
            if (!window.firebaseAuth) { showMessage('error', 'Firebase non configur√©'); return; }
            try {
                await firebaseAuth.signOut();
                setCurrentUser('');
                showMessage('success', 'D√©connect√©');
                logAudit('auth_signout', `D√©connexion`, null);
            } catch (err) { showMessage('error', err.message); }
        }

        // === SYST√àME DE SYNCHRONISATION S√õR ===
        
        // Fonction de merge : fusionner les donn√©es du client avec le serveur
        function mergeData(serverData, clientData) {
            const merged = { ...serverData };
            const mergeArray = (serverArray = [], clientArray = []) => {
                const map = {};
                serverArray.forEach(item => { if (item && item.id) map[item.id] = item; });
                clientArray.forEach(item => { if (item && item.id) map[item.id] = item; });
                return Object.values(map);
            };
            merged.membres = mergeArray(serverData.membres, clientData.membres);
            merged.payments = mergeArray(serverData.payments, clientData.payments);
            merged.expenses = mergeArray(serverData.expenses, clientData.expenses);
            return merged;
        }
        
        // Validation stricte : refuser les donn√©es vides
        function validateSyncData(data) {
            if (!data || typeof data !== 'object') return { valid: false, reason: 'Donn√©es invalides' };
            const { membres = [], payments = [], expenses = [] } = data;
            if (membres.length === 0 && payments.length === 0 && expenses.length === 0) {
                return { valid: false, reason: 'Donn√©es vides : synchronisation refus√©e' };
            }
            const hasNoId = (arr) => arr.some(item => !item || !item.id);
            if (hasNoId(membres) || hasNoId(payments) || hasNoId(expenses)) {
                return { valid: false, reason: 'Certains objets n\'ont pas d\'ID unique' };
            }
            return { valid: true };
        }
        
        // Cloud sync helpers
        async function cloudSaveAll() {
            const btnSave = document.getElementById('btn-cloud-save');
            const btnLoad = document.getElementById('btn-cloud-load');
            try {
                if (!window.firebaseAuth || !window.firebaseDb) { showMessage('error', 'Firebase non configur√©'); setSyncStatus('error', 'Firebase non configur√©'); return; }
                const user = firebaseAuth.currentUser;
                if (!user) { showMessage('error', 'Veuillez vous connecter avant de synchroniser'); setSyncStatus('error', 'Non connect√©'); return; }
                
                // VALIDATION STRICTE: Refuser les donn√©es vides
                const clientData = { membres, payments, expenses };
                const validation = validateSyncData(clientData);
                if (!validation.valid) {
                    showMessage('error', '‚ùå SYNC REFUS√âE : ' + validation.reason);
                    setSyncStatus('error', validation.reason);
                    return;
                }
                
                setSyncStatus('syncing', 'Synchronisation en cours...');
                if (btnSave) btnSave.disabled = true;
                if (btnLoad) btnLoad.disabled = true;
                
                const ref = firebaseDb.ref('users/' + user.uid);
                
                // MERGER: R√©cup√©rer les donn√©es actuelles du serveur
                const snap = await ref.once('value');
                const serverData = snap.val() || { membres: [], payments: [], expenses: [], version: 0 };
                const serverVersion = serverData.version || 0;
                const clientVersion = safeGet('dahira-sync-version', 0);
                
                // V√âRIFIER CONFLIT DE VERSION
                if (clientVersion < serverVersion) {
                    console.warn('‚ö†Ô∏è CONFLIT VERSION: client=' + clientVersion + ' serveur=' + serverVersion);
                    showMessage('warn', '‚ö†Ô∏è CONFLIT VERSION: Fusion appliqu√©e automatiquement.');
                    const mergedData = mergeData(serverData, clientData);
                    const newVersion = serverVersion + 1;
                    const payload = { ...mergedData, version: newVersion, updatedAt: new Date().toISOString() };
                    await ref.set(payload);
                    safeSet('dahira-sync-version', newVersion);
                    logAudit('cloud_save_merge', `SYNC S√âCURIS√âE (merge conflit) - ${user.email}`, null);
                } else {
                    const newVersion = serverVersion + 1;
                    const payload = { ...clientData, version: newVersion, updatedAt: new Date().toISOString() };
                    await ref.set(payload);
                    safeSet('dahira-sync-version', newVersion);
                    logAudit('cloud_save_direct', `SYNC DIRECTE - ${user.email}`, null);
                }
                
                console.info('‚úÖ cloudSaveAll: sync s√©curis√©e r√©ussie');
                showMessage('success', '‚úÖ Donn√©es synchronis√©es (mode s√©curis√©)');
                setSyncStatus('success', 'Sync r√©ussie');
                setTimeout(() => setSyncStatus('idle', 'Pr√™t'), 3000);
            } catch (err) {
                console.error('cloudSaveAll error', err);
                showMessage('error', '‚ùå Erreur sync : ' + (err.code || '') + ' ' + err.message);
                setSyncStatus('error', 'Erreur lors de la sync');
            }
            finally { if (btnSave) btnSave.disabled = false; if (btnLoad) btnLoad.disabled = false; }
        }

        async function cloudLoadAll() {
            const btnSave = document.getElementById('btn-cloud-save');
            const btnLoad = document.getElementById('btn-cloud-load');
            try {
                if (!window.firebaseAuth || !window.firebaseDb) { showMessage('error', 'Firebase non configur√©'); setSyncStatus('error', 'Firebase non configur√©'); return; }
                const user = firebaseAuth.currentUser;
                if (!user) { showMessage('error', 'Veuillez vous connecter avant d\'importer'); setSyncStatus('error', 'Non connect√©'); return; }
                setSyncStatus('syncing', 'Import cloud en cours...');
                if (btnSave) btnSave.disabled = true;
                if (btnLoad) btnLoad.disabled = true;
                const ref = firebaseDb.ref('users/' + user.uid);
                console.info('cloudLoadAll: fetching RTDB ref for', user.uid);
                const snap = await ref.once('value');
                if (!snap.exists()) { showMessage('warn', 'Aucune donn√©e cloud trouv√©e'); setSyncStatus('idle', 'Aucune donn√©e cloud'); return; }
                
                const serverData = snap.val() || {};
                const serverVersion = serverData.version || 0;
                
                // VALIDATION STRICTE: V√©rifier que les donn√©es du serveur ne sont pas vides
                const validation = validateSyncData({ membres: serverData.membres, payments: serverData.payments, expenses: serverData.expenses });
                if (!validation.valid) {
                    showMessage('error', '‚ùå DONN√âES CLOUD CORROMPUES : ' + validation.reason);
                    setSyncStatus('error', 'Donn√©es cloud invalides');
                    return;
                }
                
                console.info('cloudLoadAll: donn√©es cloud valides', { version: serverVersion, membres: (serverData.membres || []).length });
                
                showConfirm('Importer et FUSIONNER les donn√©es du cloud (pas remplacement) ?', () => {
                    // MERGER: Fusionner au lieu de remplacer
                    const localData = { membres, payments, expenses };
                    const mergedData = mergeData(serverData, localData);
                    
                    membres = mergedData.membres || [];
                    payments = mergedData.payments || [];
                    expenses = mergedData.expenses || [];
                    
                    safeSet('dahira-membres', membres);
                    safeSet('dahira-payments', payments);
                    safeSet('dahira-expenses', expenses);
                    safeSet('dahira-sync-version', serverVersion);
                    
                    renderMembres();
                    renderPayments();
                    renderExpenses();
                    updateStats();
                    updateDashboardMetrics();
                    
                    logAudit('cloud_load_merge', `IMPORT S√âCURIS√â (merge appliqu√©) - ${user.email}`, null);
                    console.info('‚úÖ cloudLoadAll: import + merge r√©ussi');
                    showMessage('success', '‚úÖ Donn√©es FUSIONN√âES (import s√©curis√©)');
                    setSyncStatus('success', 'Import termin√©');
                    setTimeout(() => setSyncStatus('idle', 'Pr√™t'), 3000);
                }, () => {
                    setSyncStatus('idle', 'Pr√™t');
                });
            } catch (err) {
                console.error('cloudLoadAll error', err);
                showMessage('error', '‚ùå Erreur import : ' + err.message);
                setSyncStatus('error', 'Erreur lors de l\'import');
            }
            finally { if (btnSave) btnSave.disabled = false; if (btnLoad) btnLoad.disabled = false; }
        }

        // Helpers: safe localStorage access with error handling
        function safeGet(key, fallback) {
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : fallback;
            } catch (err) {
                showMessage('error', `Erreur lecture localStorage (${key}): ${err.message}`);
                return fallback;
            }
        }

        function safeSet(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (err) {
                if (err.name === 'QuotaExceededError' || err.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                    showMessage('error', 'Espace localStorage insuffisant. Sauvegarde impossible.');
                } else {
                    showMessage('error', `Erreur √©criture localStorage: ${err.message}`);
                }
                return false;
            }
        }

        // Simple in-UI message (toast/banner)
        function showMessage(type, text, timeout = 4000) {
            let container = document.getElementById('app-messages');
            if (!container) {
                container = document.createElement('div');
                container.id = 'app-messages';
                container.style.position = 'fixed';
                container.style.top = '1rem';
                container.style.right = '1rem';
                container.style.zIndex = 2000;
                document.body.appendChild(container);
            }
            const el = document.createElement('div');
            el.style.marginBottom = '0.5rem';
            el.style.padding = '0.75rem 1rem';
            el.style.borderRadius = '0.5rem';
            el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
            el.style.color = 'white';
            el.style.fontWeight = '600';
            el.textContent = text;
            if (type === 'error') el.style.background = '#dc2626';
            else if (type === 'warn') el.style.background = '#f59e0b';
            else el.style.background = '#059669';
            container.appendChild(el);
            setTimeout(() => {
                el.style.transition = 'opacity 300ms';
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300);
            }, timeout);
        }

        // Sync status UI
        function setSyncStatus(state, text) {
            const el = document.getElementById('sync-status');
            if (!el) return;
            el.className = 'sync-status ' + state;
            if (state === 'syncing') {
                el.innerHTML = '<span class="sync-spinner"></span>' + (text ? (' ' + text) : ' Synchronisation...');
            } else if (state === 'success') {
                el.textContent = (text || 'Succ√®s');
            } else if (state === 'error') {
                el.textContent = (text || 'Erreur');
            } else { // idle
                el.textContent = (text || 'Idle');
            }
        }

        // --- NOUVEAU: MODE SOMBRE ---
        function initDarkMode() {
            const isDark = safeGet('dahira-dark-mode', false);
            if (isDark) document.body.classList.add('dark-mode');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            safeSet('dahira-dark-mode', isDark);
            const btn = document.getElementById('btn-theme');
            if (btn) btn.textContent = isDark ? '‚òÄÔ∏è Mode Clair' : 'üåô Mode Sombre';
        }

        // --- NOUVEAU: EXPORT EXCEL (CSV) ---
        function exportExcel() {
            // Cr√©er l'en-t√™te CSV
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF pour Excel UTF-8
            csvContent += "ID,Nom,Prenom,Sexe,Telephone,Email,Date Adhesion,Total Cotisations\n";

            // Ajouter les donn√©es
            membres.forEach(m => {
                const stats = getMemberStats(m.id);
                const row = [
                    m.id,
                    `"${m.nom}"`,
                    `"${m.prenom}"`,
                    m.sexe === 'M' ? 'Masculin' : 'F√©minin',
                    `"${m.telephone || ''}"`,
                    `"${m.email || ''}"`,
                    m.dateAdhesion,
                    stats.total
                ].join(",");
                csvContent += row + "\n";
            });

            // T√©l√©charger
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "dahira_membres_" + getTodayDateString() + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage('success', '‚úÖ Fichier Excel (CSV) g√©n√©r√© !');
        }

        // ===== FONCTIONS UTILITAIRES MOBILE =====
        
        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            if (!toast || !toastMessage) return;
            
            const icon = toast.querySelector('i');
            toastMessage.textContent = message;
            
            // Changer l'ic√¥ne selon le type
            if (icon) {
                icon.className = type === 'success' ? 'fas fa-check-circle' : 
                                type === 'error' ? 'fas fa-exclamation-circle' : 
                                'fas fa-info-circle';
            }
            
            toast.classList.add('show');
            
            // Haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(type === 'error' ? [50, 50, 50] : 30);
            }
            
            // Masquer apr√®s 3 secondes
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Gestion du FAB au scroll
        document.addEventListener('DOMContentLoaded', function() {
            // ===== ENREGISTREMENT DU SERVICE WORKER (PWA) =====
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
                        
                        // V√©rifier les mises √† jour
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nouvelle version disponible
                                    showToast('Nouvelle version disponible ! Actualisez la page.', 'info');
                                }
                            });
                        });
                    })
                    .catch((err) => {
                        console.log('‚ùå Erreur Service Worker:', err);
                    });
            }

            // ===== D√âTECTION MODE PWA =====
            const isPWA = window.matchMedia('(display-mode: standalone)').matches 
                       || window.navigator.standalone 
                       || document.referrer.includes('android-app://');
            
            if (isPWA) {
                console.log('üéâ Application lanc√©e en mode PWA standalone');
                document.body.classList.add('pwa-mode');
                
                // Masquer la barre d'adresse sur iOS
                if (window.navigator.standalone) {
                    document.body.classList.add('ios-pwa');
                }
            }

            // ===== PROMPT D'INSTALLATION PWA =====
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Afficher un message pour installer l'app
                setTimeout(() => {
                    if (!isPWA && !localStorage.getItem('pwa-prompt-dismissed')) {
                        const shouldInstall = confirm(
                            'üì± Voulez-vous installer Dahira Kenal sur votre √©cran d\'accueil ?\n\n' +
                            'L\'application fonctionnera comme une vraie app native !'
                        );
                        
                        if (shouldInstall) {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === 'accepted') {
                                    console.log('‚úÖ PWA install√©e');
                                    showToast('Application install√©e avec succ√®s ! üéâ', 'success');
                                } else {
                                    console.log('‚ùå Installation PWA refus√©e');
                                }
                                deferredPrompt = null;
                            });
                        } else {
                            localStorage.setItem('pwa-prompt-dismissed', 'true');
                        }
                    }
                }, 3000); // Afficher apr√®s 3 secondes
            });

            // Gestion du FAB
            const fab = document.querySelector('.fab');
            if (fab) {
                let lastScrollY = window.scrollY;
                
                window.addEventListener('scroll', () => {
                    const currentScrollY = window.scrollY;
                    
                    if (currentScrollY > lastScrollY && currentScrollY > 100) {
                        fab.style.transform = 'translateY(150px)';
                    } else {
                        fab.style.transform = 'translateY(0)';
                    }
                    
                    lastScrollY = currentScrollY;
                });
            }
            
            // Scroll automatique vers l'onglet actif dans la bottom nav
            scrollToActiveNavItem();
        });
        
        // Fonction pour scroller vers l'onglet actif
        function scrollToActiveNavItem() {
            const bottomNav = document.querySelector('.bottom-nav');
            const activeItem = document.querySelector('.nav-item.active');
            
            if (bottomNav && activeItem) {
                const navWidth = bottomNav.offsetWidth;
                const itemLeft = activeItem.offsetLeft;
                const itemWidth = activeItem.offsetWidth;
                
                // Centrer l'item actif
                const scrollPosition = itemLeft - (navWidth / 2) + (itemWidth / 2);
                
                bottomNav.scrollTo({
                    left: scrollPosition,
                    behavior: 'smooth'
                });
            }
        }
        
        // Current user helpers and audit logging
        function getCurrentUser() {
            try {
                const u = safeGet('dahira-current-user', '');
                return u || '';
            } catch (err) { return ''; }
        }

        function setCurrentUser(name) {
            try {
                safeSet('dahira-current-user', name || '');
                window.__currentUser = name || '';
            } catch (err) { console.warn('setCurrentUser error', err); }
        }

        function logAudit(action, details, relatedVersionId = null) {
            try {
                const user = window.__currentUser || (window.firebaseAuth && window.firebaseAuth.currentUser && (window.firebaseAuth.currentUser.email || window.firebaseAuth.currentUser.uid)) || 'anonymous';
                const audits = safeGet('dahira-audit', []);
                const entry = { id: Date.now().toString(), date: new Date().toISOString(), user, action, details, relatedVersionId };
                audits.unshift(entry);
                // keep a reasonable cap
                if (audits.length > 500) audits.pop();
                safeSet('dahira-audit', audits);
            } catch (err) {
                console.warn('logAudit error', err);
            }
        }

        function ensureMasterPassword() {
            return;
        }

        function showConfirm(message, onConfirm, onCancel) {
            const id = 'confirm-modal';
            let modal = document.getElementById(id);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = id;
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header"><h3>Confirmation</h3></div>
                        <div class="modal-body" style="padding:1.25rem;"></div>
                        <div style="display:flex; gap:0.5rem; padding:1rem; justify-content:flex-end;">
                            <button id="confirm-no" class="btn-secondary">Annuler</button>
                            <button id="confirm-yes" class="btn-primary">Confirmer</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            modal.querySelector('.modal-body').textContent = message;
            modal.classList.add('active');
            modal.querySelector('#confirm-no').onclick = () => {
                modal.classList.remove('active');
                try { if (typeof onCancel === 'function') onCancel(); } catch (e) { console.warn('onCancel error', e); }
            };
            modal.querySelector('#confirm-yes').onclick = () => {
                modal.classList.remove('active');
                try { onConfirm(); } catch (e) { console.warn('onConfirm error', e); }
            };
        }

        window.chartInstances = {};

        let membres = safeGet('dahira-membres', []);
        let payments = safeGet('dahira-payments', []);
        let expenses = safeGet('dahira-expenses', []);
        let editingMembreId = null;
        let currentMembreId = null;

        // Helper: Date du jour en YYYY-MM-DD local
        function getTodayDateString() {
            const date = new Date();
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().split('T')[0];
        }

        // ========== SYST√àME DE CARTES MEMBRES ==========
        let memberPhotos = {};

        // ========== CHARGEMENT DES PHOTOS DES MEMBRES ==========
        async function loadMemberPhotos() {
            try {
                memberPhotos = safeGet('dahira-member-photos', {});
                console.log('Photos des membres charg√©es depuis localStorage:', Object.keys(memberPhotos).length);
            } catch (error) {
                console.error('Erreur chargement photos locales:', error);
                memberPhotos = {};
            }
        }

        function deleteMemberPhoto(memberId) {
            if (memberPhotos[memberId]) {
                delete memberPhotos[memberId];
                safeSet('dahira-member-photos', memberPhotos);
                showMessage('success', 'Photo supprim√©e');
                renderCartes();
            } else {
                showMessage('warn', 'Aucune photo trouv√©e pour ce membre');
            }
        }

        async function uploadMemberPhoto(memberId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('error', 'La photo ne doit pas d√©passer 5MB');
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showMessage('error', 'Fichier invalide. S√©lectionnez une image.');
                    return;
                }
                try {
                    showMessage('info', 'Traitement de la photo...');
                    setSyncStatus('syncing', 'Sauvegarde photo...');
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const base64Data = event.target.result;
                        memberPhotos[memberId] = {
                            url: base64Data,
                            uploadedAt: new Date().toISOString(),
                            fileName: file.name,
                            fileSize: file.size,
                            local: true
                        };
                        if (safeSet('dahira-member-photos', memberPhotos)) {
                            showMessage('success', 'Photo sauvegard√©e localement avec succ√®s');
                            setSyncStatus('success', 'Photo sauvegard√©e');
                            setTimeout(() => setSyncStatus('idle', 'Pr√™t'), 2000);
                            renderCartes();
                            try { if (window.firebaseAuth && firebaseAuth.currentUser) cloudSaveAll(); } catch (e) { console.warn('cloudSaveAll error', e); }
                        } else {
                            showMessage('error', 'Erreur lors de la sauvegarde locale');
                            setSyncStatus('error', 'Erreur sauvegarde');
                        }
                    };
                    reader.onerror = function () {
                        showMessage('error', 'Erreur lors de la lecture du fichier');
                        setSyncStatus('error', 'Erreur lecture');
                    };
                    reader.readAsDataURL(file);
                } catch (err) {
                    console.error('Erreur traitement photo:', err);
                    showMessage('error', 'Erreur lors du traitement: ' + err.message);
                    setSyncStatus('error', 'Erreur traitement');
                }
            };
            input.click();
        }

        function generateQRCode(memberId, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            let profileUrl;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                profileUrl = `https://dahirakenal1-ops.github.io/DARA/profil.html?id=${memberId}`;
            } else {
                let basePath = '';
                const pathname = window.location.pathname;
                const pathParts = pathname.split('/').filter(p => p);
                if (window.location.hostname.includes('github.io') && pathParts.length > 0) {
                    const potentialRepo = pathParts[0];
                    if (!potentialRepo.includes('.')) basePath = '/' + potentialRepo;
                }
                profileUrl = `${window.location.origin}${basePath}/profil.html?id=${memberId}`;
            }
            new QRCode(container, {
                text: profileUrl,
                width: 150,
                height: 150,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function createMemberCard(membre) {
            const photoData = memberPhotos[membre.id];
            const photoUrl = photoData?.url || '';
            const qrId = `qr-${membre.id}`;
            
            // Pr√©parer la cat√©gorie d'√¢ge
            const categorieAge = membre.categorieAge || 'adulte';
            const categorieLabel = categorieAge === 'enfant' ? 'üë∂ Enfant' : 
                                   categorieAge === '3eme-age' ? 'üë¥ 3√®me √¢ge' : 
                                   'üë§ Adulte';
            
            // Pr√©parer les r√¥les
            const roles = membre.roles || [];
            const rolesDisplay = roles.length > 0 ? 
                roles.map(r => {
                    const roleLabels = {
                        'membre-simple': 'Simple',
                        'membre-finance': 'Finance',
                        'membre-bureau': 'Bureau',
                        'membre-audiovisuel': 'Audio-Visuel',
                        'membre-culturel': 'Culturel',
                        'membre-kourel': 'Kourel',
                        'membre-organisation': 'Organisation'
                    };
                    return roleLabels[r] || r;
                }).join(', ') : 'Aucun r√¥le';

            return `
                <div class="member-card-digital" id="card-${membre.id}">
                    <div class="card-header">
                        <div class="card-logo">üïå Dahira Kenal</div>
                        <div class="card-id">ID: ${membre.id.slice(-6)}</div>
                    </div>
                    
                    <div class="card-photo-section">
                        <div class="card-photo-wrapper">
                            ${photoUrl ?
                    `<img src="${photoUrl}" alt="${membre.prenom} ${membre.nom}" class="card-photo">` :
                    `<div class="card-photo">üë§</div>`
                }
                        </div>
                        <div class="card-info">
                            <div class="card-name">${membre.prenom} ${membre.nom}</div>
                            <div class="card-date">üìÖ Membre depuis le ${new Date(membre.dateAdhesion).toLocaleDateString('fr-FR')}</div>
                            <div class="card-date" style="margin-top: 0.5rem;">üîñ ${membre.sexe === 'F' ? 'Femme' : 'Homme'}</div>
                            <div class="card-date" style="margin-top: 0.5rem; color: #6b7280;">${categorieLabel}</div>
                            <div class="card-date" style="margin-top: 0.5rem; color: #059669; font-weight: 500; font-size: 0.9rem;">üéØ ${rolesDisplay}</div>
                        </div>
                    </div>
                    
                    <div class="card-qr-section">
                        <div id="${qrId}" class="card-qr-code"></div>
                    </div>
                    
                    <div class="card-actions">
                        <button class="card-action-btn" onclick="uploadMemberPhoto('${membre.id}')">
                            üì∏ Photo
                        </button>
                        ${photoUrl ? `<button class="card-action-btn" onclick="deleteMemberPhoto('${membre.id}')" style="background: #dc2626;">
                            üóëÔ∏è Supp. Photo
                        </button>` : ''}
                        <button class="card-action-btn" onclick="viewCardFullscreen('${membre.id}')">
                            üîç Voir
                        </button>
                        <button class="card-action-btn" onclick="printMemberCard('${membre.id}')">
                            üñ®Ô∏è Imprimer
                        </button>
                    </div>
                </div>
            `;
        }

        function renderCartes(searchTerm = '') {
            const container = document.getElementById('carte-list');
            if (!container) return;
            let filteredMembres = membres;
            if (searchTerm.trim()) {
                const term = searchTerm.toLowerCase().trim();
                filteredMembres = membres.filter(m => {
                    const fullName = `${m.prenom} ${m.nom}`.toLowerCase();
                    return fullName.includes(term);
                });
            }
            if (filteredMembres.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Aucun membre trouv√©</p></div>';
                return;
            }
            const sorted = [...filteredMembres].sort((a, b) => {
                const nameA = `${a.nom} ${a.prenom}`.toLowerCase();
                const nameB = `${b.nom} ${b.prenom}`.toLowerCase();
                return nameA.localeCompare(nameB);
            });
            container.innerHTML = sorted.map(m => createMemberCard(m)).join('');
            setTimeout(() => {
                sorted.forEach(m => {
                    generateQRCode(m.id, `qr-${m.id}`);
                });
            }, 100);
        }

        function viewCardFullscreen(memberId) {
            const membre = membres.find(m => m.id === memberId);
            if (!membre) return;
            const modal = document.getElementById('card-modal');
            const modalBody = document.getElementById('card-modal-body');
            modalBody.innerHTML = createMemberCard(membre);
            modal.classList.add('active');
            setTimeout(() => {
                generateQRCode(membre.id, `qr-${membre.id}`);
            }, 100);
        }

        function closeCardModal() {
            document.getElementById('card-modal').classList.remove('active');
        }

        function printMemberCard(memberId) {
            const membre = membres.find(m => m.id === memberId);
            if (!membre) return;
            const printArea = document.getElementById('print-area');
            if (!printArea) return;
            const qrId = `qr-print-${memberId}`;
            const photoData = memberPhotos[memberId];
            const photoUrl = photoData?.url || '';
            
            // Pr√©parer la cat√©gorie d'√¢ge
            const categorieAge = membre.categorieAge || 'adulte';
            const categorieLabel = categorieAge === 'enfant' ? 'üë∂ Enfant' : 
                                   categorieAge === '3eme-age' ? 'üë¥ 3√®me √¢ge' : 
                                   'üë§ Adulte';
            
            // Pr√©parer les r√¥les
            const roles = membre.roles || [];
            const rolesDisplay = roles.length > 0 ? 
                roles.map(r => {
                    const roleLabels = {
                        'membre-simple': 'Simple',
                        'membre-finance': 'Finance',
                        'membre-bureau': 'Bureau',
                        'membre-audiovisuel': 'Audio-Visuel',
                        'membre-culturel': 'Culturel',
                        'membre-kourel': 'Kourel',
                        'membre-organisation': 'Organisation'
                    };
                    return roleLabels[r] || r;
                }).join(', ') : 'Aucun r√¥le';
                
            printArea.innerHTML = `
                <div class="card-print-area" style="padding: 2rem; max-width: 600px; margin: 0 auto;">
                    <div class="member-card-digital" style="break-inside: avoid;">
                        <div class="card-header">
                            <div class="card-logo">üïå Dahira Kenal</div>
                            <div class="card-id">ID: ${membre.id.slice(-6)}</div>
                        </div>
                        <div class="card-photo-section">
                            <div class="card-photo-wrapper">
                                ${photoUrl ?
                    `<img src="${photoUrl}" alt="${membre.prenom} ${membre.nom}" class="card-photo">` :
                    `<div class="card-photo">üë§</div>`
                }
                            </div>
                            <div class="card-info">
                                <div class="card-name">${membre.prenom} ${membre.nom}</div>
                                <div class="card-date">üìÖ Membre depuis le ${new Date(membre.dateAdhesion).toLocaleDateString('fr-FR')}</div>
                                <div class="card-date" style="margin-top: 0.5rem;">üîñ ${membre.sexe === 'F' ? 'Femme' : 'Homme'}</div>
                                <div class="card-date" style="margin-top: 0.5rem; color: #6b7280;">${categorieLabel}</div>
                                <div class="card-date" style="margin-top: 0.5rem; color: #059669; font-weight: 500;">üéØ ${rolesDisplay}</div>
                            </div>
                        </div>
                        <div class="card-qr-section">
                            <div id="${qrId}" class="card-qr-code"></div>
                        </div>
                    </div>
                </div>
            `;
            printArea.style.display = 'block';
            setTimeout(() => {
                generateQRCode(membre.id, qrId);
                setTimeout(() => {
                    window.print();
                    setTimeout(() => printArea.style.display = 'none', 1000);
                }, 500);
            }, 100);
        }

        document.addEventListener('click', (e) => {
            const modal = document.getElementById('card-modal');
            if (e.target === modal) closeCardModal();
        });

        function showTab(tabName, event) {
            // G√©rer les tabs desktop
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            // G√©rer la bottom nav mobile
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            // G√©rer le contenu
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (event) {
                const clickedElement = event.target.closest('.tab, .nav-item');
                if (clickedElement) {
                    clickedElement.classList.add('active');
                }
            } else {
                // Activer les tabs desktop
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(t => {
                    if (t.getAttribute('onclick') && t.getAttribute('onclick').includes(`'${tabName}'`)) {
                        t.classList.add('active');
                    }
                });
                // Activer la bottom nav mobile
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(n => {
                    if (n.getAttribute('data-tab') === tabName) {
                        n.classList.add('active');
                    }
                });
            }

            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Haptic feedback sur mobile
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
            
            // Scroller vers l'onglet actif dans la bottom nav
            setTimeout(() => scrollToActiveNavItem(), 100);
            
            if (tabName === 'evenements') {
                eventsModule.render();
            }
            if (tabName === 'stats') updateStats();
            if (tabName === 'calculateur') loadCalculatorData();
            if (tabName === 'rapports') {
                initRapportDates();
                updateEventReportsButtons();
            }
            if (tabName === 'dashboard') initDashboard();
            if (tabName === 'paiements') renderPayments();
            if (tabName === 'depenses') renderExpenses();
            if (tabName === 'carte') {
                loadMemberPhotos().then(() => {
                    const searchTerm = document.getElementById('carte-search-input').value;
                    renderCartes(searchTerm);
                });
            }
        }

        function openWhatsApp(phoneNumber, memberName, memberId) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const currentMonthPayments = payments.filter(p => {
                const paymentDate = new Date(p.date);
                return p.memberId === memberId &&
                    paymentDate.getMonth() === currentMonth &&
                    paymentDate.getFullYear() === currentYear;
            });
            const hebdoPaid = currentMonthPayments
                .filter(p => p.type === 'hebdomadaire')
                .reduce((sum, p) => sum + p.montant, 0);
            const mensuelPaid = currentMonthPayments
                .filter(p => p.type === 'mensuelle')
                .reduce((sum, p) => sum + p.montant, 0);
            const hebdoRequired = 1000;
            const mensuelRequired = 500;
            const hebdoRemaining = Math.max(0, hebdoRequired - hebdoPaid);
            const mensuelRemaining = Math.max(0, mensuelRequired - mensuelPaid);
            const totalRemaining = hebdoRemaining + mensuelRemaining;
            let cleanNumber = phoneNumber.replace(/\s+/g, '').replace(/[^\d]/g, '');
            if (cleanNumber.startsWith('77') || cleanNumber.startsWith('78') || cleanNumber.startsWith('76') || cleanNumber.startsWith('70')) {
                cleanNumber = '221' + cleanNumber;
            } else if (!cleanNumber.startsWith('221') && cleanNumber.length === 9) {
                cleanNumber = '221' + cleanNumber;
            }
            let message = `Assalamou aleykoum ${memberName}, ceci est un message de la Dahira Kenal.`;
            if (totalRemaining > 0) {
                message += `\n\n Il vous reste des ADIYA ce mois-ci :\n`;
                if (hebdoRemaining > 0) message += `‚Ä¢ Hebdomadaire : ${hebdoRemaining} FCFA\n`;
                if (mensuelRemaining > 0) message += `‚Ä¢ Mensuelle : ${mensuelRemaining} FCFA\n`;
                message += `‚Ä¢ Total restant : ${totalRemaining} FCFA\n\nQue Allah vous facilite . `;
            } else {
                message += `\n\n‚úÖ Alhamdoulilah ! Vous √™tes √† jour pour ce mois-ci.\n\nBarakallahu fik pour votre engagement. `;
            }
            const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function openModal(type, membreId = null) {
            if (type === 'addMember') {
                document.getElementById('modal-membre-title').textContent = 'Nouveau Membre';
                document.getElementById('membre-nom').value = '';
                document.getElementById('membre-prenom').value = '';
                document.getElementById('membre-sexe').value = 'M';
                document.getElementById('membre-tel').value = '';
                document.getElementById('membre-date').value = getTodayDateString();
                document.getElementById('membre-categorie-age').value = 'adulte';
                // D√©cocher toutes les checkboxes de r√¥les
                document.getElementById('role-simple').checked = false;
                document.getElementById('role-finance').checked = false;
                document.getElementById('role-bureau').checked = false;
                document.getElementById('role-audiovisuel').checked = false;
                document.getElementById('role-culturel').checked = false;
                document.getElementById('role-kourel').checked = false;
                document.getElementById('role-organisation').checked = false;
                editingMembreId = null;
                document.getElementById('modal-membre').classList.add('active');
            } else if (type === 'editMember') {
                const membre = membres.find(m => m.id === membreId);
                document.getElementById('modal-membre-title').textContent = 'Modifier le Membre';
                document.getElementById('membre-nom').value = membre.nom;
                document.getElementById('membre-prenom').value = membre.prenom;
                document.getElementById('membre-sexe').value = membre.sexe || 'M';
                document.getElementById('membre-tel').value = membre.telephone || ''; // handle undefined
                document.getElementById('membre-email').value = membre.email || '';
                document.getElementById('membre-date').value = membre.dateAdhesion;
                document.getElementById('membre-categorie-age').value = membre.categorieAge || 'adulte';
                // Cocher les r√¥les du membre
                const roles = membre.roles || [];
                document.getElementById('role-simple').checked = roles.includes('membre-simple');
                document.getElementById('role-finance').checked = roles.includes('membre-finance');
                document.getElementById('role-bureau').checked = roles.includes('membre-bureau');
                document.getElementById('role-audiovisuel').checked = roles.includes('membre-audiovisuel');
                document.getElementById('role-culturel').checked = roles.includes('membre-culturel');
                document.getElementById('role-kourel').checked = roles.includes('membre-kourel');
                document.getElementById('role-organisation').checked = roles.includes('membre-organisation');
                editingMembreId = membreId;
                document.getElementById('modal-membre').classList.add('active');
            } else if (type === 'addPayment') {
                currentMembreId = membreId;
                document.getElementById('payment-type').innerHTML = `
                    <option value="hebdomadaire">Hebdomadaire (250 FCFA)</option>
                    <option value="mensuelle">Mensuelle (500 FCFA)</option>
                    <option value="social">Caisse sociale (500 FCFA)</option>
                    <option value="diayante">Diayante (10000 FCFA)</option>
                    ${eventsModule.getEvents().map(evt => `<option value="${evt.caisse}">${evt.title} (${evt.fee} FCFA)</option>`).join('')}
                `;
                document.getElementById('payment-date').value = getTodayDateString();
                document.getElementById('payment-type').value = 'hebdomadaire';
                document.getElementById('payment-montant').value = '250';
                document.getElementById('payment-methode').value = 'esp√®ces';
                document.getElementById('modal-paiement').classList.add('active');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openCardModal(memberId) {
            const membre = membres.find(m => m.id === memberId);
            if (!membre) return;
            const stats = getMemberStats(memberId);
            const photoData = memberPhotos[memberId];
            const photoUrl = photoData?.url || 'https://via.placeholder.com/150x150?text=Photo';
            const categorieAge = membre.categorieAge || 'adulte';
            const categorieLabel = categorieAge === 'enfant' ? 'üë∂ Enfant' : 
                                   categorieAge === '3eme-age' ? 'üë¥ 3√®me √¢ge' : 
                                   'üë§ Adulte';
            const roles = membre.roles || [];
            const rolesDisplay = roles.length > 0 ? 
                roles.map(r => {
                    const roleLabels = {
                        'membre-simple': 'üë• Simple',
                        'membre-finance': 'üí∞ Finance',
                        'membre-bureau': 'üè¢ Bureau',
                        'membre-audiovisuel': 'üé• Audio-Visuel',
                        'membre-culturel': 'üìö Culturel',
                        'membre-kourel': 'üïå Kourel',
                        'membre-organisation': 'üìã Organisation'
                    };
                    return roleLabels[r] || r;
                }).join(', ') : 'Aucun r√¥le';
                
            const modalBody = document.getElementById('card-modal-body');
            modalBody.innerHTML = `
                <div class="member-card-digital large">
                    <div class="card-header">
                        <div class="card-photo">
                            <img src="${photoUrl}" alt="Photo de ${membre.prenom} ${membre.nom}" onerror="this.src='https://via.placeholder.com/150x150?text=Photo'">
                        </div>
                        <div class="card-info">
                            <h2>${membre.prenom} ${membre.nom}</h2>
                            <p>üìÖ ${new Date(membre.dateAdhesion).toLocaleDateString('fr-FR')}</p>
                            <p>üìû ${membre.telephone || 'Non fourni'}</p>
                            <p>‚úâÔ∏è ${membre.email || 'Non fourni'}</p>
                            <p style="color: #6b7280; margin-top: 0.5rem;">${categorieLabel}</p>
                            <p style="color: #059669; font-weight: 500; margin-top: 0.25rem;">${rolesDisplay}</p>
                        </div>
                    </div>
                    <div class="card-stats">
                        <div class="stat-item">
                            <span class="stat-label">Hebdo</span>
                            <span class="stat-value">${stats.hebdo} F</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Mensuel</span>
                            <span class="stat-value">${stats.mensuel} F</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total</span>
                            <span class="stat-value">${stats.total} F</span>
                        </div>
                    </div>
                    <div class="card-qr large">
                        <div id="modal-qr-${membre.id}" class="qr-code"></div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                const qrContainer = document.getElementById(`modal-qr-${membre.id}`);
                if (qrContainer && window.QRCode) {
                    let profileUrl;
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                        profileUrl = `https://dahirakenal1-ops.github.io/DARA/profil.html?id=${membre.id}`;
                    } else {
                        const pathParts = window.location.pathname.split('/').filter(p => p);
                        const repoName = pathParts.length > 0 && window.location.hostname.includes('github.io') ? pathParts[0] : '';
                        const baseUrl = repoName ? `${window.location.origin}/${repoName}` : window.location.origin;
                        profileUrl = `${baseUrl}/profil.html?id=${membre.id}`;
                    }
                    new QRCode(qrContainer, {
                        text: profileUrl,
                        width: 150,
                        height: 150
                    });
                }
            }, 100);
            document.getElementById('card-modal').classList.add('active');
        }

        function closeCardModal() {
            document.getElementById('card-modal').classList.remove('active');
        }

        function saveMembre() {
            const nom = document.getElementById('membre-nom').value.trim();
            const prenom = document.getElementById('membre-prenom').value.trim();
            const sexe = document.getElementById('membre-sexe').value;
            let telephone = document.getElementById('membre-tel').value.trim();
            const email = document.getElementById('membre-email').value.trim();
            const dateAdhesion = document.getElementById('membre-date').value;
            const categorieAge = document.getElementById('membre-categorie-age').value;
            
            // R√©cup√©rer les r√¥les s√©lectionn√©s
            const roles = [];
            if (document.getElementById('role-simple').checked) roles.push('membre-simple');
            if (document.getElementById('role-finance').checked) roles.push('membre-finance');
            if (document.getElementById('role-bureau').checked) roles.push('membre-bureau');
            if (document.getElementById('role-audiovisuel').checked) roles.push('membre-audiovisuel');
            if (document.getElementById('role-culturel').checked) roles.push('membre-culturel');
            if (document.getElementById('role-kourel').checked) roles.push('membre-kourel');
            if (document.getElementById('role-organisation').checked) roles.push('membre-organisation');

            if (!nom || !prenom) {
                showMessage('error', 'Veuillez remplir au moins le nom et le pr√©nom');
                return;
            }

            if (telephone && !validatePhone(telephone)) {
                showFieldError('membre-tel-error', 'Num√©ro invalide. Exemple: 77 123 45 67');
                document.getElementById('membre-tel').classList.add('input-invalid');
                return;
            } else {
                hideFieldError('membre-tel-error');
                document.getElementById('membre-tel').classList.remove('input-invalid');
            }

            if (email && !validateEmail(email)) {
                showFieldError('membre-email-error', 'Email invalide');
                document.getElementById('membre-email').classList.add('input-invalid');
                return;
            } else {
                hideFieldError('membre-email-error');
                document.getElementById('membre-email').classList.remove('input-invalid');
            }

            if (editingMembreId) {
                const index = membres.findIndex(m => m.id === editingMembreId);
                membres[index] = { id: editingMembreId, nom, prenom, sexe, telephone, email, dateAdhesion, categorieAge, roles };
            } else {
                membres.push({
                    id: Date.now().toString(),
                    nom,
                    prenom,
                    sexe,
                    telephone,
                    email,
                    dateAdhesion,
                    categorieAge,
                    roles
                });
            }

            if (safeSet('dahira-membres', membres)) {
                showMessage('success', 'Membre enregistr√©');
            }
            renderMembres();
            try { if (window.firebaseAuth && firebaseAuth.currentUser) cloudSaveAll(); } catch (e) { console.warn('cloudSaveAll error', e); }
            updateDashboardMetrics();
            closeModal('modal-membre');
        }

        function deleteMembre(id) {
            showConfirm('√ätes-vous s√ªr de vouloir supprimer ce membre ?', () => {
                membres = membres.filter(m => m.id !== id);
                payments = payments.filter(p => p.memberId !== id);
                safeSet('dahira-membres', membres);
                safeSet('dahira-payments', payments);
                renderMembres();
                renderPayments();
                updateDashboardMetrics();
                try { if (window.firebaseAuth && firebaseAuth.currentUser) cloudSaveAll(); } catch (e) { console.warn('cloudSaveAll error', e); }
                showMessage('success', 'Membre supprim√©');
            });
        }

        function deletePayment(id) {
            showConfirm('√ätes-vous s√ªr de vouloir supprimer ce paiement ?', () => {
                payments = payments.filter(p => p.id !== id);
                safeSet('dahira-payments', payments);
                renderMembres();
                renderPayments();
                updateStats();
                updateDashboardMetrics();
                try { if (window.firebaseAuth && firebaseAuth.currentUser) cloudSaveAll(); } catch (e) { console.warn('cloudSaveAll error', e); }
                showMessage('success', 'Paiement supprim√©');
            });
        }

        function savePayment() {
            const montant = parseFloat(document.getElementById('payment-montant').value);
            const type = document.getElementById('payment-type').value;
            const date = document.getElementById('payment-date').value;
            const methode = document.getElementById('payment-methode').value;
            if (!montant || isNaN(montant) || montant <= 0) {
                showFieldError('payment-montant-error', 'Montant invalide');
                document.getElementById('payment-montant').classList.add('input-invalid');
                return;
            }
            hideFieldError('payment-montant-error');
            document.getElementById('payment-montant').classList.remove('input-invalid');

            payments.push({
                id: Date.now().toString(),
                memberId: currentMembreId,
                montant,
                type,
                date,
                methode
            });

            if (safeSet('dahira-payments', payments)) {
                showMessage('success', 'Paiement enregistr√©');
            }
            renderMembres();
            renderPayments();
            try { if (window.firebaseAuth && firebaseAuth.currentUser) cloudSaveAll(); } catch (e) { console.warn('cloudSaveAll error', e); }
            updateDashboardMetrics();
            closeModal('modal-paiement');
        }

        function updatePaymentAmount() {
            const type = document.getElementById('payment-type').value;
            let amount = '250';
            if (type === 'mensuelle') amount = '500';
            else if (type === 'social') amount = '500';
            else if (type === 'diayante') amount = '10000';
            else if (type.startsWith('event-')) {
                const eventsData = eventsModule.getEvents();
                const evt = eventsData.find(e => e.caisse === type);
                if (evt) amount = evt.fee.toString();
            }
            document.getElementById('payment-montant').value = amount;
        }

        function getMemberStats(memberId) {
            const memberPayments = payments.filter(p => p.memberId === memberId);
            const hebdo = memberPayments.filter(p => p.type === 'hebdomadaire').reduce((sum, p) => sum + p.montant, 0);
            const mensuel = memberPayments.filter(p => p.type === 'mensuelle').reduce((sum, p) => sum + p.montant, 0);
            const diayante = memberPayments.filter(p => p.type === 'diayante').reduce((sum, p) => sum + p.montant, 0);
            const social = memberPayments.filter(p => p.type === 'social').reduce((sum, p) => sum + p.montant, 0);
            return { hebdo, mensuel, diayante, social, total: hebdo + mensuel + diayante + social };
        }

        function getPaymentStatus(memberId) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentMonthPayments = payments.filter(p => {
                const paymentDate = new Date(p.date);
                return p.memberId === memberId && paymentDate.getMonth() === currentMonth;
            });
            const hebdoTotal = currentMonthPayments
                .filter(p => p.type === 'hebdomadaire')
                .reduce((sum, p) => sum + p.montant, 0);
            const mensuelTotal = currentMonthPayments
                .filter(p => p.type === 'mensuelle')
                .reduce((sum, p) => sum + p.montant, 0);
            return (hebdoTotal >= 1000 && mensuelTotal >= 500) ? '√Ä jour' : 'En retard';
        }

        function renderMembres() {
            const list = document.getElementById('membres-list');
            if (!list) return;
            
            const searchInputEl = document.getElementById('search-input');
            const filterOkEl = document.getElementById('filter-ok');
            const filterLateEl = document.getElementById('filter-late');
            const filterSexeEl = document.querySelector('input[name="filter-sexe"]:checked');
            
            const searchTerm = searchInputEl ? searchInputEl.value.toLowerCase() : '';
            const filterOk = filterOkEl ? filterOkEl.checked : true;
            const filterLate = filterLateEl ? filterLateEl.checked : true;
            const filterSexe = filterSexeEl ? filterSexeEl.value : '';

            let filtered = membres.filter(m => {
                const fullName = `${m.prenom} ${m.nom}`.toLowerCase();
                const matchesSearch = fullName.includes(searchTerm);
                const status = getPaymentStatus(m.id);
                const matchesFilter = (status === '√Ä jour' && filterOk) || (status === 'En retard' && filterLate);
                const matchesSexe = filterSexe === '' || (m.sexe || 'M') === filterSexe;
                return matchesSearch && matchesFilter && matchesSexe;
            });

            filtered.sort((a, b) => {
                const nameA = `${a.nom} ${a.prenom}`.toLowerCase();
                const nameB = `${b.nom} ${b.prenom}`.toLowerCase();
                return nameA.localeCompare(nameB);
            });

            const membreCount = document.getElementById('membre-count');
            if (membreCount) {
                membreCount.textContent = filtered.length;
            }

            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>Aucun membre trouv√©</p></div>';
                return;
            }

            list.innerHTML = filtered.map(m => {
                const stats = getMemberStats(m.id);
                const status = getPaymentStatus(m.id);
                const categorieAge = m.categorieAge || 'adulte';
                const categorieLabel = categorieAge === 'enfant' ? 'üë∂ Enfant' : 
                                       categorieAge === '3eme-age' ? 'üë¥ 3√®me √¢ge' : 
                                       'üë§ Adulte';
                const roles = m.roles || [];
                const rolesDisplay = roles.length > 0 ? 
                    roles.map(r => {
                        const roleLabels = {
                            'membre-simple': 'üë• Simple',
                            'membre-finance': 'üí∞ Finance',
                            'membre-bureau': 'üè¢ Bureau',
                            'membre-audiovisuel': 'üé• Audio-Visuel',
                            'membre-culturel': 'üìö Culturel',
                            'membre-kourel': 'üïå Kourel',
                            'membre-organisation': 'üìã Organisation'
                        };
                        return roleLabels[r] || r;
                    }).join(', ') : 'Aucun r√¥le';
                    
                return `
                    <div class="member-card">
                        <div class="member-header">
                            <div>
                                <div class="member-name">${m.prenom} ${m.nom}</div>
                                <div class="member-date">üìÖ ${new Date(m.dateAdhesion).toLocaleDateString('fr-FR')}</div>
                                <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem;">${categorieLabel}</div>
                                <div style="font-size: 0.85rem; color: #059669; margin-top: 0.25rem; font-weight: 500;">${rolesDisplay}</div>
                                <span class="status-badge ${status === '√Ä jour' ? 'status-ok' : 'status-late'}">${status}</span>
                            </div>
                            <div class="member-actions">
                                ${m.telephone ? `<a href="tel:${m.telephone}" class="btn-icon btn-call">üìû</a>` : ''}
                                ${m.telephone ? `<button class="btn-icon btn-whatsapp" onclick="openWhatsApp('${m.telephone}', '${m.prenom} ${m.nom}', '${m.id}')">üí¨</button>` : ''}
                                <button class="btn-icon btn-edit" onclick="openModal('editMember', '${m.id}')">‚úèÔ∏è</button>
                                <button class="btn-icon btn-delete" onclick="deleteMembre('${m.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">Hebdo</div>
                                <div class="stat-value">${stats.hebdo} F</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Mensuel</div>
                                <div class="stat-value">${stats.mensuel} F</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Total</div>
                                <div class="stat-value">${stats.total} F</div>
                            </div>
                        </div>
                        <button class="btn-primary" style="width: 100%; margin-top: 1rem;" onclick="openModal('addPayment', '${m.id}')">
                            Ajouter un ADIYA
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderPayments() {
            const list = document.getElementById('payments-list');
            document.getElementById('payment-count').textContent = payments.length;

            if (payments.length === 0) {
                list.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Aucun paiement</td></tr>';
                return;
            }

            const sorted = [...payments].sort((a, b) => new Date(b.date) - new Date(a.date));
            list.innerHTML = sorted.map(p => {
                const membre = membres.find(m => m.id === p.memberId);
                let displayType = p.type;
                let typeClass = '';
                if (p.type === 'hebdomadaire') { typeClass = 'hebdo'; displayType = 'Hebdomadaire'; }
                else if (p.type === 'mensuelle') { typeClass = 'mensuel'; displayType = 'Mensuelle'; }
                else if (p.type === 'diayante') { typeClass = 'diayante'; displayType = 'Diayante'; }
                else if (p.type === 'social') { typeClass = 'social'; displayType = 'Sociale'; }
                else if (p.type.startsWith('event-')) {
                    const eventsData = eventsModule.getEvents();
                    const evt = eventsData.find(e => e.caisse === p.type);
                    if (evt) {
                        displayType = evt.title;
                        typeClass = 'event';
                    } else {
                        typeClass = 'unknown';
                    }
                } else {
                    typeClass = 'unknown';
                }

                return `
                    <tr>
                        <td>${new Date(p.date).toLocaleDateString('fr-FR')}</td>
                        <td><strong>${membre ? `${membre.prenom} ${membre.nom}` : 'Inconnu'}</strong></td>
                        <td><span class="payment-type type-${typeClass}">${displayType}</span></td>
                        <td><span class="payment-method">${p.methode || 'Esp√®ces'}</span></td>
                        <td style="text-align: right; font-weight: bold;">${p.montant} FCFA</td>
                        <td><button class="btn-icon btn-print" onclick="generateReceipt('${p.id}')">üñ®Ô∏è</button> <button class="btn-icon btn-delete" onclick="deletePayment('${p.id}')">üóëÔ∏è</button></td>
                    </tr>
                `;
            }).join('');
        }

        function openExpenseModal() {
            document.getElementById('expense-label').value = '';
            document.getElementById('expense-montant').value = '';
            document.getElementById('expense-caisse').innerHTML = `
                <option value="hebdomadaire">Hebdomadaire</option>
                <option value="mensuelle">Mensuelle</option>
                <option value="social">Sociale</option>
                <option value="diayante">Diayante</option>
                ${eventsModule.getEvents().map(evt => `<option value="${evt.caisse}">${evt.title}</option>`).join('')}
            `;
            document.getElementById('expense-caisse').value = 'hebdomadaire';
            document.getElementById('expense-date').value = getTodayDateString();
            document.getElementById('modal-depense').classList.add('active');
        }

        function saveExpense() {
            const label = document.getElementById('expense-label').value.trim();
            const montant = parseFloat(document.getElementById('expense-montant').value);
            const caisse = document.getElementById('expense-caisse').value;
            const date = document.getElementById('expense-date').value;
            if (!label) { showMessage('error', 'Entrez un libell√© pour la d√©pense'); return; }
            if (!montant || isNaN(montant) || montant <= 0) { showFieldError('expense-montant-error', 'Montant invalide'); document.getElementById('expense-montant').classList.add('input-invalid'); return; }
            hideFieldError('expense-montant-error'); document.getElementById('expense-montant').classList.remove('input-invalid');

            const balance = getBalanceForCaisse(caisse);
            if (montant > balance) {
                showMessage('error', '‚ö†Ô∏è Fonds insuffisants ! Vous ne pouvez pas d√©penser plus que ce qui est disponible dans cette caisse.');
                return;
            }

            expenses.push({ id: Date.now().toString(), label, montant, caisse, date });
            if (safeSet('dahira-expenses', expenses)) { showMessage('success', 'D√©pense enregistr√©e'); }
            renderExpenses();
            updateStats();
            renderDashboardCharts();
            try { if (window.firebaseAuth && firebaseAuth.currentUser) cloudSaveAll(); } catch (e) { console.warn('cloudSaveAll error', e); }
            updateDashboardMetrics();
            closeModal('modal-depense');
        }

        function deleteExpense(id) {
            showConfirm('√ätes-vous s√ªr de vouloir supprimer cette d√©pense ?', () => {
                expenses = expenses.filter(e => e.id !== id);
                safeSet('dahira-expenses', expenses);
                renderExpenses();
                updateStats();
                renderDashboardCharts();
                try { if (window.firebaseAuth && firebaseAuth.currentUser) cloudSaveAll(); } catch (e) { console.warn('cloudSaveAll error', e); }
                updateDashboardMetrics();
                showMessage('success', 'D√©pense supprim√©e');
            });
        }

        function renderExpenses() {
            const list = document.getElementById('expenses-list');
            document.getElementById('expense-count').textContent = expenses.length;
            if (expenses.length === 0) {
                list.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Aucune d√©pense</td></tr>';
                return;
            }
            const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            list.innerHTML = sorted.map(e => {
                let displayCaisse = e.caisse;
                let caisseClass = '';
                if (e.caisse === 'hebdomadaire') { caisseClass = 'hebdo'; displayCaisse = 'Hebdomadaire'; }
                else if (e.caisse === 'mensuelle') { caisseClass = 'mensuel'; displayCaisse = 'Mensuelle'; }
                else if (e.caisse === 'diayante') { caisseClass = 'diayante'; displayCaisse = 'Diayante'; }
                else if (e.caisse === 'social') { caisseClass = 'social'; displayCaisse = 'Sociale'; }
                else if (e.caisse.startsWith('event-')) {
                    const eventsData = eventsModule.getEvents();
                    const evt = eventsData.find(ev => ev.caisse === e.caisse);
                    if (evt) {
                        displayCaisse = evt.title;
                        caisseClass = 'event';
                    } else {
                        caisseClass = 'unknown';
                    }
                } else {
                    caisseClass = 'unknown';
                }

                return `
                    <tr>
                        <td>${new Date(e.date).toLocaleDateString('fr-FR')}</td>
                        <td>${e.label}</td>
                        <td><span class="payment-type type-${caisseClass}">${displayCaisse}</span></td>
                        <td style="text-align:right; font-weight:bold;">${e.montant} FCFA</td>
                        <td><button class="btn-icon btn-delete" onclick="deleteExpense('${e.id}')">üóëÔ∏è</button></td>
                    </tr>
                `;
            }).join('');
        }

        function getBalanceForCaisse(caisse) {
            const incomes = payments.filter(p => p.type === caisse).reduce((s, p) => s + p.montant, 0);
            const expensesSum = expenses.filter(e => e.caisse === caisse).reduce((s, e) => s + e.montant, 0);
            return incomes - expensesSum;
        }

        function updateStats() {
            const hebdo = payments.filter(p => p.type === 'hebdomadaire').reduce((s, p) => s + p.montant, 0);
            const mensuel = payments.filter(p => p.type === 'mensuelle').reduce((s, p) => s + p.montant, 0);
            const diayante = payments.filter(p => p.type === 'diayante').reduce((s, p) => s + p.montant, 0);
            const social = payments.filter(p => p.type === 'social').reduce((s, p) => s + p.montant, 0);

            const expenseHebdo = expenses.filter(e => e.caisse === 'hebdomadaire').reduce((s, e) => s + e.montant, 0);
            const expenseMensuel = expenses.filter(e => e.caisse === 'mensuelle').reduce((s, e) => s + e.montant, 0);
            const expenseDiayante = expenses.filter(e => e.caisse === 'diayante').reduce((s, e) => s + e.montant, 0);
            const expenseSocial = expenses.filter(e => e.caisse === 'social').reduce((s, e) => s + e.montant, 0);
            const totalExpenses = expenseHebdo + expenseMensuel + expenseDiayante + expenseSocial;

            const netHebdo = hebdo - expenseHebdo;
            const netMensuel = mensuel - expenseMensuel;
            const netSocial = social - expenseSocial;
            const netDiayante = diayante - expenseDiayante;
            const netGlobal = netHebdo + netMensuel + netSocial + netDiayante;

            document.getElementById('total-hebdo').textContent = netHebdo;
            document.getElementById('total-mensuel').textContent = netMensuel;
            document.getElementById('total-social').textContent = netSocial;
            document.getElementById('total-diayante').textContent = netDiayante;
            document.getElementById('total-global').textContent = netGlobal;

            const eHeb = document.getElementById('expense-hebdo'); if (eHeb) eHeb.textContent = expenseHebdo;
            const eMen = document.getElementById('expense-mensuel'); if (eMen) eMen.textContent = expenseMensuel;
            const eSoc = document.getElementById('expense-social'); if (eSoc) eSoc.textContent = expenseSocial;
            const eDia = document.getElementById('expense-diayante'); if (eDia) eDia.textContent = expenseDiayante;
            const eTot = document.getElementById('total-expenses'); if (eTot) eTot.textContent = totalExpenses;

            // Add event stats cards
            // Remove existing event cards first
            document.querySelectorAll('.event-stats-card').forEach(card => card.remove());
            const eventsData = eventsModule.getEvents();
            let eventNetTotal = 0;
            let eventExpenseTotal = 0;
            eventsData.forEach(evt => {
                const revenues = payments.filter(p => p.type === evt.caisse).reduce((s, p) => s + p.montant, 0);
                const expensesEvt = expenses.filter(e => e.caisse === evt.caisse).reduce((s, e) => s + e.montant, 0);
                const net = revenues - expensesEvt;
                eventNetTotal += net;
                eventExpenseTotal += expensesEvt;
                const card = document.createElement('div');
                card.className = 'stats-card event-stats-card';
                card.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                card.innerHTML = `
                    <h3>${evt.title}</h3>
                    <p class="big-number">${net}</p>
                    <p style="opacity: 0.8;">FCFA</p>
                    <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: ${expensesEvt} FCFA</p>
                `;
                document.querySelector('.stats-cards').appendChild(card);
            });

            // Update global totals to include events
            const updatedNetGlobal = netGlobal + eventNetTotal;
            const updatedTotalExpenses = totalExpenses + eventExpenseTotal;
            document.getElementById('total-global').textContent = updatedNetGlobal;
            if (eTot) eTot.textContent = updatedTotalExpenses;

            const details = document.getElementById('stats-details');
            details.innerHTML = `
                <div class="member-card">
                    <h3 style="margin-bottom: 1rem;">D√©tails par Membre</h3>
                    ${membres.map(m => {
                const stats = getMemberStats(m.id);
                return `
                            <div style="border-left: 4px solid #059669; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="font-weight: bold;">${m.prenom} ${m.nom}</h4>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 0.5rem;">
                                    <div><span style="color: #6b7280;">Hebdo:</span> <strong>${stats.hebdo} F</strong></div>
                                    <div><span style="color: #6b7280;">Mensuel:</span> <strong>${stats.mensuel} F</strong></div>
                                    <div><span style="color: #6b7280;">Diayante:</span> <strong>${stats.diayante} F</strong></div>
                                    <div><span style="color: #6b7280;">Total:</span> <strong style="color: #059669;">${stats.total} F</strong></div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function exportData() {
            const data = {
                membres,
                payments,
                expenses,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dahira-kenal-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('success', '‚úÖ Donn√©es export√©es avec succ√®s !');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.membres || !data.payments) {
                        showMessage('error', '‚ùå Fichier invalide !');
                        return;
                    }
                    showConfirm('‚ö†Ô∏è Cela va remplacer toutes vos donn√©es. Continuer ?', () => {
                        membres = data.membres;
                        payments = data.payments;
                        expenses = data.expenses || [];
                        safeSet('dahira-membres', membres);
                        safeSet('dahira-payments', payments);
                        safeSet('dahira-expenses', expenses);
                        renderMembres();
                        renderPayments();
                        renderExpenses();
                        updateDashboardMetrics();
                        showMessage('success', '‚úÖ Donn√©es import√©es !');
                    });
                } catch (error) {
                    showMessage('error', '‚ùå Erreur: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function generateReceipt(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            const membre = membres.find(m => m.id === payment.memberId);
            if (!membre) return;

            let displayType = payment.type;
            if (payment.type === 'hebdomadaire') displayType = 'Hebdomadaire';
            else if (payment.type === 'mensuelle') displayType = 'Mensuelle';
            else if (payment.type === 'diayante') displayType = 'Diayante';
            else if (payment.type === 'social') displayType = 'Sociale';
            else if (payment.type.startsWith('event-')) {
                const eventsData = eventsModule.getEvents();
                const evt = eventsData.find(e => e.caisse === payment.type);
                if (evt) displayType = evt.title;
            }

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div style="max-width: 600px; margin: 2rem auto; padding: 2rem; border: 2px solid #059669; border-radius: 1rem;">
                    <div style="text-align: center; border-bottom: 2px solid #059669; padding-bottom: 1rem; margin-bottom: 1rem;">
                        <h1 style="color: #059669; margin-bottom: 0.5rem;">üïå Dahira Kenal</h1>
                        <p style="color: #6b7280;">Re√ßu de Cotisation</p>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>Membre:</strong> <span>${membre.prenom} ${membre.nom}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>Type:</strong> <span>${displayType}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>M√©thode:</strong> <span>${payment.methode || 'Esp√®ces'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>Date:</strong> <span>${new Date(payment.date).toLocaleDateString('fr-FR')}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>R√©f√©rence:</strong> <span>${payment.id}</span>
                        </div>
                    </div>
                    <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #059669; border-top: 2px solid #e5e7eb; padding-top: 1rem;">
                        Montant: ${payment.montant} FCFA
                    </div>
                    <div style="text-align: center; color: #6b7280; font-size: 0.875rem; margin-top: 1rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                        G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}
                    </div>
                </div>
            `;
            printArea.style.display = 'block';
            window.print();
            setTimeout(() => printArea.style.display = 'none', 1000);
        }

        function initRapportDates() {
            const today = getTodayDateString();
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const firstDayOffset = firstDay.getTimezoneOffset() * 60000;
            const firstDayStr = new Date(firstDay.getTime() - firstDayOffset).toISOString().split('T')[0];

            document.getElementById('rapport-start').value = firstDayStr;
            document.getElementById('rapport-end').value = today;
        }

        function generateRapportHebdo() {
            generateRapport('hebdomadaire', 'Rapport Hebdomadaire');
        }

        function generateRapportMensuel() {
            generateRapport('mensuelle', 'Rapport Mensuel');
        }

        function generateRapportDiayante() {
            generateRapport('diayante', 'Rapport Diayante');
        }

        function generateRapportSocial() {
            generateRapport('social', 'Rapport Social');
        }

        function generateRapportGlobal() {
            generateRapport('all', 'Rapport Global');
        }

        function generateRapportHommes() {
            const hommes = membres.filter(m => m.sexe === 'M');
            const total = hommes.length;
            const content = document.getElementById('rapport-content');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: #059669; margin-bottom: 0.5rem;">Rapport Membres Hommes</h2>
                    <p>Total des hommes: ${total}</p>
                </div>
                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">
                    <h3 style="font-size: 2rem; color: #059669; margin-bottom: 0.5rem;">${total}</h3>
                    <p style="color: #6b7280;">Hommes inscrits</p>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Nom</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Pr√©nom</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">T√©l√©phone</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Date d'adh√©sion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${hommes.map(m => `
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.nom}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.prenom}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.tel || m.telephone || '-'}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${new Date(m.dateAdhesion).toLocaleDateString('fr-FR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('rapport-preview').style.display = 'block';
            document.getElementById('rapport-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function generateRapportFemmes() {
            const femmes = membres.filter(m => m.sexe === 'F');
            const total = femmes.length;
            const content = document.getElementById('rapport-content');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: #ec4899; margin-bottom: 0.5rem;">Rapport Membres Femmes</h2>
                    <p>Total des femmes: ${total}</p>
                </div>
                <div style="background: #fdf2f8; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">
                    <h3 style="font-size: 2rem; color: #ec4899; margin-bottom: 0.5rem;">${total}</h3>
                    <p style="color: #6b7280;">Femmes inscrites</p>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Nom</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Pr√©nom</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">T√©l√©phone</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Date d'adh√©sion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${femmes.map(m => `
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.nom}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.prenom}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.tel || m.telephone || '-'}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${new Date(m.dateAdhesion).toLocaleDateString('fr-FR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('rapport-preview').style.display = 'block';
            document.getElementById('rapport-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function generateRapportTousMembres() {
            const hommes = membres.filter(m => m.sexe === 'M');
            const femmes = membres.filter(m => m.sexe === 'F');
            const total = membres.length;
            const content = document.getElementById('rapport-content');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: #059669; margin-bottom: 0.5rem;">Rapport Tous les Membres</h2>
                    <p>Total des membres: ${total}</p>
                </div>
                <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                    <div style="flex: 1; background: #f0fdf4; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">
                        <h3 style="font-size: 2rem; color: #059669; margin-bottom: 0.5rem;">${hommes.length}</h3>
                        <p style="color: #6b7280;">Hommes</p>
                    </div>
                    <div style="flex: 1; background: #fdf2f8; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">
                        <h3 style="font-size: 2rem; color: #ec4899; margin-bottom: 0.5rem;">${femmes.length}</h3>
                        <p style="color: #6b7280;">Femmes</p>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Nom</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Pr√©nom</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #e5e7eb;">Sexe</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">T√©l√©phone</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Date d'adh√©sion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${membres.map(m => `
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.nom}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.prenom}</td>
                                <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb;">${m.sexe === 'M' ? 'Homme' : 'Femme'}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.tel || m.telephone || '-'}</td>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${new Date(m.dateAdhesion).toLocaleDateString('fr-FR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('rapport-preview').style.display = 'block';
            document.getElementById('rapport-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function generateRapportDepenses() {
            const start = new Date(document.getElementById('rapport-start').value);
            const end = new Date(document.getElementById('rapport-end').value);
            const filtered = expenses.filter(e => {
                const d = new Date(e.date);
                return d >= start && d <= end;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            const total = filtered.reduce((s, e) => s + e.montant, 0);
            const byCaisse = {};
            filtered.forEach(e => {
                if (!byCaisse[e.caisse]) byCaisse[e.caisse] = { total: 0, count: 0 };
                byCaisse[e.caisse].total += e.montant;
                byCaisse[e.caisse].count += 1;
            });
            const content = document.getElementById('rapport-content');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: #b91c1c; margin-bottom: 0.5rem;">Rapport D√©penses</h2>
                    <p>Du ${start.toLocaleDateString('fr-FR')} au ${end.toLocaleDateString('fr-FR')}</p>
                </div>
                <div style="background: #fff7ed; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">
                    <h3 style="font-size: 2rem; color: #b91c1c; margin-bottom: 0.5rem;">${total} FCFA</h3>
                    <p style="color: #6b7280;">Total des d√©penses - ${filtered.length} op√©rations</p>
                </div>
                <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                    ${Object.keys(byCaisse).map(c => `
                        <div style="flex:1; background:#fff7ed; padding:1rem; border-radius:0.5rem; text-align:center;">
                            <div style="font-size:0.9rem; color:#6b7280;">${c}</div>
                            <div style="font-weight:700; font-size:1.25rem; color:#b91c1c;">${byCaisse[c].total} FCFA</div>
                            <div style="color:#6b7280; font-size:0.85rem;">${byCaisse[c].count} ops</div>
                        </div>
                    `).join('')}
                </div>
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f9fafb;">
                            <th style="padding:0.75rem; text-align:left; border-bottom:1px solid #eee;">Date</th>
                            <th style="padding:0.75rem; text-align:left; border-bottom:1px solid #eee;">Libell√©</th>
                            <th style="padding:0.75rem; text-align:left; border-bottom:1px solid #eee;">Caisse</th>
                            <th style="padding:0.75rem; text-align:right; border-bottom:1px solid #eee;">Montant</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(e => `
                            <tr>
                                <td style="padding:0.5rem; border-bottom:1px solid #f1f5f9;">${new Date(e.date).toLocaleDateString('fr-FR')}</td>
                                <td style="padding:0.5rem; border-bottom:1px solid #f1f5f9;">${e.label}</td>
                                <td style="padding:0.5rem; border-bottom:1px solid #f1f5f9;">${e.caisse}</td>
                                <td style="padding:0.5rem; text-align:right; border-bottom:1px solid #f1f5f9; font-weight:700;">${e.montant} FCFA</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('rapport-preview').style.display = 'block';
            document.getElementById('rapport-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function generateRapport(type, title) {
            const start = new Date(document.getElementById('rapport-start').value);
            const end = new Date(document.getElementById('rapport-end').value);

            const filtered = payments.filter(p => {
                const date = new Date(p.date);
                const matchesType = type === 'all' || p.type === type;
                return matchesType && date >= start && date <= end;
            });

            const total = filtered.reduce((s, p) => s + p.montant, 0);
            const byMember = {};

            filtered.forEach(p => {
                if (!byMember[p.memberId]) {
                    const membre = membres.find(m => m.id === p.memberId);
                    byMember[p.memberId] = {
                        nom: membre ? `${membre.prenom} ${membre.nom}` : 'Inconnu',
                        total: 0,
                        count: 0
                    };
                }
                byMember[p.memberId].total += p.montant;
                byMember[p.memberId].count++;
            });

            const content = document.getElementById('rapport-content');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: #059669; margin-bottom: 0.5rem;">${title}</h2>
                    <p>Du ${start.toLocaleDateString('fr-FR')} au ${end.toLocaleDateString('fr-FR')}</p>
                </div>
                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">
                    <h3 style="font-size: 2rem; color: #059669; margin-bottom: 0.5rem;">${total} FCFA</h3>
                    <p style="color: #6b7280;">Total collect√© - ${filtered.length} ADIYA</p>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Membre</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #e5e7eb;">ADIYA</th>
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.values(byMember).map(m => `
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.nom}</td>
                                <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb;">${m.count}</td>
                                <td style="padding: 0.75rem; text-align: right; font-weight: bold; border-bottom: 1px solid #e5e7eb;">${m.total} FCFA</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('rapport-preview').style.display = 'block';
            document.getElementById('rapport-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function updateEventReportsButtons() {
            const container = document.getElementById('event-reports-buttons');
            if (!container) return;
            const eventsData = eventsModule.getEvents();
            container.innerHTML = eventsData.map(evt => `<button class="btn-primary" onclick="generateRapportEvenement('${evt.id}')">üìÑ Rapport ${evt.title}</button>`).join('');
        }

        function generateRapportEvenement(id) {
            const evt = eventsModule.getEvents().find(e => e.id === id);
            if (!evt) return;
            const start = new Date(document.getElementById('rapport-start').value);
            const end = new Date(document.getElementById('rapport-end').value);
            const filtered = payments.filter(p => {
                const date = new Date(p.date);
                const matchesType = p.type === evt.caisse;
                return matchesType && date >= start && date <= end;
            });
            const total = filtered.reduce((s, p) => s + p.montant, 0);
            const byMember = {};
            filtered.forEach(p => {
                if (!byMember[p.memberId]) {
                    const membre = membres.find(m => m.id === p.memberId);
                    byMember[p.memberId] = {
                        nom: membre ? `${membre.prenom} ${membre.nom}` : 'Inconnu',
                        total: 0,
                        count: 0
                    };
                }
                byMember[p.memberId].total += p.montant;
                byMember[p.memberId].count++;
            });
            const content = document.getElementById('rapport-content');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: #8b5cf6; margin-bottom: 0.5rem;">Rapport ${evt.title}</h2>
                    <p>Du ${start.toLocaleDateString('fr-FR')} au ${end.toLocaleDateString('fr-FR')}</p>
                </div>
                <div style="background: #f3e8ff; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">
                    <h3 style="font-size: 2rem; color: #8b5cf6; margin-bottom: 0.5rem;">${total} FCFA</h3>
                    <p style="color: #6b7280;">Total collect√© - ${filtered.length} ADIYA</p>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Membre</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #e5e7eb;">Cotisations</th>
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.values(byMember).map(m => `
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${m.nom}</td>
                                <td style="padding: 0.75rem; text-align: center; border-bottom: 1px solid #e5e7eb;">${m.count}</td>
                                <td style="padding: 0.75rem; text-align: right; font-weight: bold; border-bottom: 1px solid #e5e7eb;">${m.total} FCFA</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('rapport-preview').style.display = 'block';
            document.getElementById('rapport-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function printRapport() {
            const content = document.getElementById('rapport-content');
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h1 style="color: #059669;">üïå Dahira Kenal</h1>
                    </div>
                    ${content.innerHTML}
                    <div style="margin-top: 3rem; text-align: center; color: #6b7280; font-size: 0.875rem;">
                        G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}
                    </div>
                </div>
            `;
            printArea.style.display = 'block';
            window.print();
            setTimeout(() => printArea.style.display = 'none', 1000);
        }

        function loadCalculatorData() {
            const select = document.getElementById('calc-member');
            if (!select) return;
            select.innerHTML = '<option value="">S√©lectionner...</option>';
            membres.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = `${m.prenom} ${m.nom}`;
                select.appendChild(option);
            });
            calculateGlobal();
        }

        function calculateIndividual() {
            const memberId = document.getElementById('calc-member').value;
            const period = parseInt(document.getElementById('calc-period').value) || 1;
            const result = document.getElementById('calc-result');
            if (!memberId) {
                result.innerHTML = '<p style="color: #6b7280;">S√©lectionnez un membre</p>';
                return;
            }
            const membre = membres.find(m => m.id === memberId);
            const stats = getMemberStats(memberId);
            const hebdoDue = 250 * 4 * period;
            const mensuelDue = 500 * period;
            const totalDue = hebdoDue + mensuelDue;
            const balance = totalDue - stats.total;
            result.innerHTML = `
                <h4 style="color: #059669; margin-bottom: 1rem;">${membre.prenom} ${membre.nom}</h4>
                <div style="margin-bottom: 0.5rem;"><strong>P√©riode:</strong> ${period} mois</div>
                <div style="margin-bottom: 0.5rem;"><strong>Total pay√©:</strong> ${stats.total} FCFA</div>
                <div style="margin-bottom: 0.5rem;"><strong>D√ª:</strong> ${totalDue} FCFA</div>
                <div style="margin-top: 1rem; padding: 1rem; background: ${balance > 0 ? '#fef2f2' : '#f0fdf4'}; border-radius: 0.5rem;">
                    <strong style="color: ${balance > 0 ? '#dc2626' : '#059669'};">
                        ${balance > 0 ? `Reste √† payer: ${balance} FCFA` : '√Ä jour ‚úì'}
                    </strong>
                </div>
            `;
        }

        function calculateGlobal() {
            const total = parseInt(document.getElementById('calc-total').value) || 10;
            const period = parseInt(document.getElementById('calc-global-period').value) || 1;
            const result = document.getElementById('calc-global-result');
            const hebdoTotal = total * 250 * 4 * period;
            const mensuelTotal = total * 500 * period;
            const grandTotal = hebdoTotal + mensuelTotal;
            result.innerHTML = `
                <h4 style="color: #059669; margin-bottom: 1rem;">Projection Globale</h4>
                <div style="margin-bottom: 0.5rem;"><strong>Membres:</strong> ${total}</div>
                <div style="margin-bottom: 0.5rem;"><strong>P√©riode:</strong> ${period} mois</div>
                <div style="margin-bottom: 0.5rem;"><strong>Hebdo estim√©:</strong> ${hebdoTotal} FCFA</div>
                <div style="margin-bottom: 0.5rem;"><strong>Mensuel estim√©:</strong> ${mensuelTotal} FCFA</div>
                <div style="margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem; text-align: center;">
                    <strong style="font-size: 1.5rem; color: #059669;">${grandTotal} FCFA</strong>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">Total projet√©</p>
                </div>
            `;
        }

        // PROTECTION CONTRE LES APPELS DANGEREUX
        // Wrapper s√©curis√© : emp√™cher les √©crasages
        function protectDataWrite(data, operationName = 'unknown') {
            if (!data || typeof data !== 'object') {
                console.error('‚ùå PROT√âG√â: Tentative d\'√©criture invalide -', operationName);
                return false;
            }
            const totalItems = (data.membres || []).length + (data.payments || []).length + (data.expenses || []).length;
            if (totalItems === 0) {
                console.error('‚ùå PROT√âG√â: Tentative d\'√©criture de donn√©es VIDES -', operationName);
                showMessage('error', '‚ùå REFUS√â : Impossible d\'√©crire des donn√©es vides.');
                return false;
            }
            console.info('‚úÖ VALID√â: √âcriture autoris√©e -', operationName);
            return true;
        }
        
        // Override des fonctions exportData/importData pour s√©curiser aussi les exports/imports locaux
        const originalExportData = window.exportData;
        window.exportData = function() {
            const data = { membres, payments, expenses, exportDate: new Date().toISOString(), version: safeGet('dahira-sync-version', 0) };
            if (!protectDataWrite(data, 'exportData')) return;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dahira-kenal-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('success', '‚úÖ Donn√©es export√©es avec succ√®s !');
        };
        
        const originalImportData = window.importData;
        window.importData = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // VALIDATION STRICTE
                    const validation = validateSyncData(data);
                    if (!validation.valid) {
                        showMessage('error', '‚ùå Fichier invalide : ' + validation.reason);
                        return;
                    }
                    
                    showConfirm('‚ö†Ô∏è FUSIONNER (pas remplacer) les donn√©es du fichier ?', () => {
                        const localData = { membres, payments, expenses };
                        const mergedData = mergeData(data, localData);
                        
                        membres = mergedData.membres;
                        payments = mergedData.payments;
                        expenses = mergedData.expenses;
                        
                        safeSet('dahira-membres', membres);
                        safeSet('dahira-payments', payments);
                        safeSet('dahira-expenses', expenses);
                        renderMembres();
                        renderPayments();
                        renderExpenses();
                        updateDashboardMetrics();
                        showMessage('success', '‚úÖ Donn√©es FUSIONN√âES (import local s√©curis√©) !');
                        logAudit('import_local_merge', 'Import local avec merge', null);
                    });
                } catch (error) {
                    showMessage('error', '‚ùå Erreur : ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        };
        
        function showFieldError(id, msg) {
            const el = document.getElementById(id);
            if (el) { el.textContent = msg; el.style.display = 'block'; }
        }
        
        function hideFieldError(id) {
            const el = document.getElementById(id);
            if (el) { el.textContent = ''; el.style.display = 'none'; }
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhone(tel) {
            const cleaned = tel.replace(/\D/g, '');
            const rest = cleaned.startsWith('221') ? cleaned.slice(3) : cleaned;
            return rest.length === 9 && /^7\d{8}$/.test(rest);
        }

        function renderVersions() {
            const list = document.getElementById('versions-list');
            const versions = safeGet('dahira-versions', []);
            if (!versions.length) {
                list.innerHTML = '<p>Aucune version disponible</p>';
                return;
            }
            list.innerHTML = versions.map(v => `
                <div style="padding:0.5rem 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:0.95rem; color:#374151;">${new Date(v.date).toLocaleString('fr-FR')}</div>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn-secondary" onclick="restoreVersion('${v.id}')">Restaurer</button>
                        <button class="btn-delete" onclick="deleteVersion('${v.id}')">Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        function autosave() {
            try {
                const snapshot = { membres: membres, payments: payments, expenses: expenses };
                const versions = safeGet('dahira-versions', []);
                const last = versions[0];
                const currentDataStr = JSON.stringify(snapshot);
                if (last && JSON.stringify(last.data) === JSON.stringify(snapshot)) return;
                versions.unshift({ id: Date.now().toString(), date: new Date().toISOString(), data: snapshot });
                // OPTIMISATION: Garder seulement les 5 derni√®res versions pour √©viter la saturation m√©moire
                if (versions.length > 5) versions.pop();
                safeSet('dahira-versions', versions);
                showMessage('info', 'Sauvegarde automatique effectu√©e');
                renderVersions();
            } catch (err) {
                showMessage('error', 'Erreur autosave: ' + err.message);
            }
        }

        function openVersions() {
            renderVersions();
            document.getElementById('modal-versions').classList.add('active');
        }

        function restoreVersion(id) {
            const versions = safeGet('dahira-versions', []);
            const v = versions.find(x => x.id === id);
            if (!v) { showMessage('error', 'Version introuvable'); return; }
            showConfirm('Restaurer cette version ? Les donn√©es actuelles seront remplac√©es.', () => {
                membres = v.data.membres || [];
                payments = v.data.payments || [];
                safeSet('dahira-membres', membres);
                safeSet('dahira-payments', payments);
                renderMembres();
                renderPayments();
                updateDashboardMetrics();
                showMessage('success', 'Version restaur√©e');
                closeModal('modal-versions');
            });
        }

        function deleteVersion(id) {
            showConfirm('Supprimer cette version ?', () => {
                let versions = safeGet('dahira-versions', []);
                versions = versions.filter(v => v.id !== id);
                safeSet('dahira-versions', versions);
                renderVersions();
                showMessage('success', 'Version supprim√©e');
            });
        }

        function resetAllData() {
            if (confirm("ATTENTION: Cette action va effacer TOUTES les donn√©es (membres, paiements, etc). √ätes-vous vraiment s√ªr ?")) {
                if (confirm("Derni√®re chance: Cela est irr√©versible. Confirmer la suppression ?")) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        function generateBulkReminder() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            const lateMembers = membres.filter(m => {
                const status = getPaymentStatus(m.id);
                return status === 'En retard';
            });

            if (lateMembers.length === 0) {
                showMessage('success', 'Tout le monde est √† jour ! Alhamdoulilah.');
                return;
            }

            let message = `üïå *DAHIRA KENAL - Rappel Adiya* üïå\n\n`;
            message += `Assalamou aleykoum chers talib√©s. Voici la liste des membres qui ont des cotisations en retard pour ce mois-ci:\n\n`;

            lateMembers.forEach(m => {
                const stats = getMemberStats(m.id);
                const memberPayments = payments.filter(p => {
                    const d = new Date(p.date);
                    return p.memberId === m.id && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const hebdoPaid = memberPayments.filter(p => p.type === 'hebdomadaire').reduce((s, p) => s + p.montant, 0);
                const mensuelPaid = memberPayments.filter(p => p.type === 'mensuelle').reduce((s, p) => s + p.montant, 0);

                const hebdoDue = Math.max(0, 1000 - hebdoPaid);
                const mensuelDue = Math.max(0, 500 - mensuelPaid);
                const total = hebdoDue + mensuelDue;

                const phone = m.telephone ? ` (${m.telephone})` : '';
                message += `‚Ä¢ ${m.prenom} ${m.nom}${phone}: ${total} FCFA\n`;
            });

            message += `\nQue Allah vous facilite si bark√© serigne bi. Barakallahu fikoum.`;

            document.getElementById('reminder-text').value = message;
            document.getElementById('bulk-reminder-area').style.display = 'block';
            document.getElementById('bulk-reminder-area').scrollIntoView({ behavior: 'smooth' });
        }

        function copyToClipboard() {
            const copyText = document.getElementById("reminder-text");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value).then(() => {
                showMessage('success', 'Texte copi√© dans le presse-papier !');
            });
        }

        // OPTIMISATION RECHERCHE: Formatage t√©l√©phone auto
        document.getElementById('membre-tel').addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,3})(\d{0,2})(\d{0,2})/);
            if (x) {
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '') + (x[4] ? ' ' + x[4] : '');
            }
            const v = e.target.value.replace(/\D/g, '');
            if (v.length > 0 && !validatePhone(v)) {
                showFieldError('membre-tel-error', 'Num√©ro invalide (doit commencer par 7)');
                e.target.classList.add('input-invalid');
            } else {
                hideFieldError('membre-tel-error');
                e.target.classList.remove('input-invalid');
            }
        });

        document.getElementById('membre-email').addEventListener('input', (e) => {
            const v = e.target.value.trim();
            if (!v) { hideFieldError('membre-email-error'); e.target.classList.remove('input-invalid'); return; }
            if (!validateEmail(v)) { showFieldError('membre-email-error', 'Email invalide'); e.target.classList.add('input-invalid'); }
            else { hideFieldError('membre-email-error'); e.target.classList.remove('input-invalid'); }
        });

        document.getElementById('payment-montant').addEventListener('input', (e) => {
            const v = parseFloat(e.target.value);
            if (!v || isNaN(v) || v <= 0) { showFieldError('payment-montant-error', 'Montant invalide'); e.target.classList.add('input-invalid'); }
            else { hideFieldError('payment-montant-error'); e.target.classList.remove('input-invalid'); }
        });

        // OPTIMISATION: Debounce sur la recherche pour √©viter de recalculer √† chaque frappe
        const debouncedRenderMembres = debounce(renderMembres, 300);
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', debouncedRenderMembres);
        }

        const filterOk = document.getElementById('filter-ok');
        const filterLate = document.getElementById('filter-late');
        if (filterOk) filterOk.addEventListener('change', renderMembres);
        if (filterLate) filterLate.addEventListener('change', renderMembres);

        document.querySelectorAll('input[name="filter-sexe"]').forEach(radio => {
            radio.addEventListener('change', renderMembres);
        });

        // OPTIMISATION RECHERCHE CARTE: Debounce
        const debouncedRenderCartes = debounce((e) => {
            const searchTerm = e.target.value;
            renderCartes(searchTerm);
        }, 300);
        const carteSearchInput = document.getElementById('carte-search-input');
        if (carteSearchInput) {
            carteSearchInput.addEventListener('input', debouncedRenderCartes);
        }

        setInterval(autosave, 30000);
        autosave();

        setTimeout(() => {
            initDarkMode(); // Initialiser le th√®me
            const firebaseOk = testFirebaseConfig();
            console.log('‚úÖ Stockage des photos configur√© en local');
        }, 1000);

        loadMemberPhotos();
        renderMembres();
        renderPayments();
        initRapportDates();

        function testFirebaseConfig() {
            console.log('=== STOCKAGE LOCAL ACTIF ===');
            console.log('‚úÖ Stockage des photos en localStorage');
            console.log('‚úÖ Pas de d√©pendance Firebase pour les photos');
            return true;
        }

        function initDashboard() {
            updateDashboardMetrics();
            renderDashboardCharts();
        }

        function updateDashboardMetrics() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            const currentMonthPayments = payments.filter(p => {
                const paymentDate = new Date(p.date);
                return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
            });

            const cotisationsMois = currentMonthPayments.reduce((sum, p) => sum + p.montant, 0);

            const currentMonthExpenses = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const depensesMois = currentMonthExpenses.reduce((sum, e) => sum + e.montant, 0);
            const solde = cotisationsMois - depensesMois;

            const lastMonthPayments = payments.filter(p => {
                const paymentDate = new Date(p.date);
                return paymentDate.getMonth() === lastMonth && paymentDate.getFullYear() === lastMonthYear;
            });

            const cotisationsLastMonth = lastMonthPayments.reduce((sum, p) => sum + p.montant, 0);
            const soldeTrend = cotisationsLastMonth > 0 ? ((solde - cotisationsLastMonth) / cotisationsLastMonth * 100).toFixed(1) : 0;

            const nouveauxMembres = membres.filter(m => {
                const adhesionDate = new Date(m.dateAdhesion);
                return adhesionDate.getMonth() === currentMonth && adhesionDate.getFullYear() === currentYear;
            }).length;

            const anneePayments = payments.filter(p => {
                const paymentDate = new Date(p.date);
                return paymentDate.getFullYear() === currentYear;
            });

            const cotisationsAnnee = anneePayments.reduce((sum, p) => sum + p.montant, 0);
            const ratioDepenses = cotisationsMois > 0 ? ((depensesMois / cotisationsMois) * 100).toFixed(1) : 0;

            let membresAJour = 0;
            membres.forEach(membre => {
                const memberPayments = payments.filter(p => {
                    const paymentDate = new Date(p.date);
                    return p.memberId === membre.id &&
                        paymentDate.getMonth() === currentMonth &&
                        paymentDate.getFullYear() === currentYear;
                });

                const hebdoTotal = memberPayments
                    .filter(p => p.type === 'hebdomadaire')
                    .reduce((sum, p) => sum + p.montant, 0);

                const mensuelTotal = memberPayments
                    .filter(p => p.type === 'mensuelle')
                    .reduce((sum, p) => sum + p.montant, 0);

                if (hebdoTotal >= 1000 && mensuelTotal >= 500) {
                    membresAJour++;
                }
            });

            const tauxPaiement = membres.length > 0 ? ((membresAJour / membres.length) * 100).toFixed(1) : 0;
            const moyenneMembre = membres.length > 0 ? (cotisationsMois / membres.length).toFixed(0) : 0;

            const lastMonthNouveaux = membres.filter(m => {
                const adhesionDate = new Date(m.dateAdhesion);
                return adhesionDate.getMonth() === lastMonth && adhesionDate.getFullYear() === lastMonthYear;
            }).length;

            const croissance = lastMonthNouveaux > 0 ? (((nouveauxMembres - lastMonthNouveaux) / lastMonthNouveaux) * 100).toFixed(1) : (nouveauxMembres > 0 ? 100 : 0);

            const troisMoisAgo = new Date();
            troisMoisAgo.setMonth(troisMoisAgo.getMonth() - 3);

            const membresActifs = new Set();
            payments.forEach(p => {
                const paymentDate = new Date(p.date);
                if (paymentDate >= troisMoisAgo) {
                    membresActifs.add(p.memberId);
                }
            });

            const tauxActivite = membres.length > 0 ? ((membresActifs.size / membres.length) * 100).toFixed(1) : 0;

            const totalRevenus = cotisationsMois;
            const ratioEquilibre = totalRevenus > 0 ? ((depensesMois / totalRevenus) * 100).toFixed(1) : 0;

            const objectifMensuel = membres.length * (1000 + 500);
            const performance = objectifMensuel > 0 ? ((cotisationsMois / objectifMensuel) * 100).toFixed(1) : 0;

            document.getElementById('dashboard-total-membres').textContent = membres.length;
            document.getElementById('dashboard-cotisations-mois').textContent = cotisationsMois + ' FCFA';
            document.getElementById('dashboard-depenses-mois').textContent = depensesMois + ' FCFA';
            document.getElementById('dashboard-solde').textContent = solde + ' FCFA';
            document.getElementById('dashboard-nouveaux-membres').textContent = nouveauxMembres;
            document.getElementById('dashboard-cotisations-mois').textContent = cotisationsMois.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('dashboard-cotisations-annee').textContent = cotisationsAnnee.toLocaleString('fr-FR');
            document.getElementById('dashboard-depenses-mois').textContent = depensesMois.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('dashboard-ratio-depenses').textContent = ratioDepenses + '%';
            document.getElementById('dashboard-solde').textContent = solde.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('dashboard-solde-trend').innerHTML = (soldeTrend >= 0 ? '‚ÜóÔ∏è +' : '‚ÜòÔ∏è ') + soldeTrend + '%';

            document.getElementById('kpi-taux-paiement').textContent = tauxPaiement + '%';
            document.getElementById('kpi-membres-ajour').textContent = membresAJour;
            document.getElementById('kpi-moyenne-membre').textContent = moyenneMembre + ' FCFA';
            document.getElementById('kpi-croissance').textContent = (croissance >= 0 ? '+' : '') + croissance + '%';
            document.getElementById('kpi-activite').textContent = tauxActivite + '%';
            document.getElementById('kpi-equilibre').textContent = ratioEquilibre + '%';
            document.getElementById('kpi-performance').textContent = performance + '%';
        }

        // Correction Bug Graphiques: Gestion de la m√©moire
        function destroyChart(key) {
            if (window.chartInstances[key]) {
                window.chartInstances[key].destroy();
                delete window.chartInstances[key];
            }
        }

        function renderDashboardCharts() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js n\'est pas charg√©');
                return;
            }
            renderChartSexe();
            renderChartEvolution();
            renderChartPaiementsCaisse();
            renderChartStatutPaiements();
            renderChartDepensesCaisse();
            renderChartTopContributeurs();
        }

        function renderChartSexe() {
            const ctx = document.getElementById('chart-sexe');
            if (!ctx) return;
            destroyChart('sexe');

            const hommes = membres.filter(m => m.sexe === 'M').length;
            const femmes = membres.filter(m => m.sexe === 'F').length;

            window.chartInstances['sexe'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Hommes', 'Femmes'],
                    datasets: [{
                        data: [hommes, femmes],
                        backgroundColor: ['#059669', '#ec4899'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderChartEvolution() {
            const ctx = document.getElementById('chart-evolution');
            if (!ctx) return;
            destroyChart('evolution');

            const monthlyData = {};
            membres.forEach(membre => {
                const date = new Date(membre.dateAdhesion);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                return new Date(year, monthNum - 1).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
            });
            const data = sortedMonths.map(month => monthlyData[month]);

            window.chartInstances['evolution'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nouveaux membres',
                        data: data,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        function renderChartPaiementsCaisse() {
            const ctx = document.getElementById('chart-paiements-caisse');
            if (!ctx) return;
            destroyChart('paiements-caisse');

            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    label: date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }),
                    year: date.getFullYear(),
                    month: date.getMonth()
                });
            }

            const datasets = [
                {
                    label: 'Hebdomadaire',
                    data: months.map(m => payments.filter(p =>
                        p.type === 'hebdomadaire' &&
                        new Date(p.date).getFullYear() === m.year &&
                        new Date(p.date).getMonth() === m.month
                    ).reduce((sum, p) => sum + p.montant, 0)),
                    backgroundColor: '#059669'
                },
                {
                    label: 'Mensuelle',
                    data: months.map(m => payments.filter(p =>
                        p.type === 'mensuelle' &&
                        new Date(p.date).getFullYear() === m.year &&
                        new Date(p.date).getMonth() === m.month
                    ).reduce((sum, p) => sum + p.montant, 0)),
                    backgroundColor: '#3b82f6'
                },
                {
                    label: 'Social',
                    data: months.map(m => payments.filter(p =>
                        p.type === 'social' &&
                        new Date(p.date).getFullYear() === m.year &&
                        new Date(p.date).getMonth() === m.month
                    ).reduce((sum, p) => sum + p.montant, 0)),
                    backgroundColor: '#f59e0b'
                },
                {
                    label: 'Diayante',
                    data: months.map(m => payments.filter(p =>
                        p.type === 'diayante' &&
                        new Date(p.date).getFullYear() === m.year &&
                        new Date(p.date).getMonth() === m.month
                    ).reduce((sum, p) => sum + p.montant, 0)),
                    backgroundColor: '#7c3aed'
                }
            ];

            window.chartInstances['paiements-caisse'] = new Chart(ctx, {
                type: 'bar',
                data: { labels: months.map(m => m.label), datasets: datasets },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: function (value) { return value + ' FCFA'; } }
                        }
                    }
                }
            });
        }

        function renderChartStatutPaiements() {
            const ctx = document.getElementById('chart-statut-paiements');
            if (!ctx) return;
            destroyChart('statut-paiements');

            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            let aJour = 0;
            let enRetard = 0;

            membres.forEach(membre => {
                const memberPayments = payments.filter(p => {
                    const paymentDate = new Date(p.date);
                    return p.memberId === membre.id &&
                        paymentDate.getMonth() === currentMonth &&
                        paymentDate.getFullYear() === currentYear;
                });

                const hebdoTotal = memberPayments
                    .filter(p => p.type === 'hebdomadaire')
                    .reduce((sum, p) => sum + p.montant, 0);

                const mensuelTotal = memberPayments
                    .filter(p => p.type === 'mensuelle')
                    .reduce((sum, p) => sum + p.montant, 0);

                if (hebdoTotal >= 1000 && mensuelTotal >= 500) {
                    aJour++;
                } else {
                    enRetard++;
                }
            });

            window.chartInstances['statut-paiements'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['√Ä jour', 'En retard'],
                    datasets: [{
                        data: [aJour, enRetard],
                        backgroundColor: ['#059669', '#dc2626'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderChartDepensesCaisse() {
            const ctx = document.getElementById('chart-depenses-caisse');
            if (!ctx) return;
            destroyChart('depenses-caisse');

            // Calculer les 6 derniers mois
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    label: date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }),
                    year: date.getFullYear(),
                    month: date.getMonth()
                });
            }

            const datasets = [
                {
                    label: 'Hebdomadaire',
                    data: months.map(m => expenses.filter(e =>
                        e.caisse === 'hebdomadaire' &&
                        new Date(e.date).getFullYear() === m.year &&
                        new Date(e.date).getMonth() === m.month
                    ).reduce((sum, e) => sum + e.montant, 0)),
                    backgroundColor: '#dc2626'
                },
                {
                    label: 'Mensuelle',
                    data: months.map(m => expenses.filter(e =>
                        e.caisse === 'mensuelle' &&
                        new Date(e.date).getFullYear() === m.year &&
                        new Date(e.date).getMonth() === m.month
                    ).reduce((sum, e) => sum + e.montant, 0)),
                    backgroundColor: '#ea580c'
                },
                {
                    label: 'Social',
                    data: months.map(m => expenses.filter(e =>
                        e.caisse === 'social' &&
                        new Date(e.date).getFullYear() === m.year &&
                        new Date(e.date).getMonth() === m.month
                    ).reduce((sum, e) => sum + e.montant, 0)),
                    backgroundColor: '#d97706'
                },
                {
                    label: 'Diayante',
                    data: months.map(m => expenses.filter(e =>
                        e.caisse === 'diayante' &&
                        new Date(e.date).getFullYear() === m.year &&
                        new Date(e.date).getMonth() === m.month
                    ).reduce((sum, e) => sum + e.montant, 0)),
                    backgroundColor: '#c2410c'
                },
                {
                    label: '√âv√©nements',
                    data: months.map(m => expenses.filter(e =>
                        e.caisse.startsWith('event-') &&
                        new Date(e.date).getFullYear() === m.year &&
                        new Date(e.date).getMonth() === m.month
                    ).reduce((sum, e) => sum + e.montant, 0)),
                    backgroundColor: '#7c3aed'
                }
            ];

            window.chartInstances['depenses-caisse'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months.map(m => m.label),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value + ' FCFA';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderChartTopContributeurs() {
            const ctx = document.getElementById('chart-top-contributeurs');
            if (!ctx) return;
            destroyChart('top-contributeurs');

            // Calculer le total des contributions par membre
            const contributions = {};
            membres.forEach(membre => {
                const total = payments
                    .filter(p => p.memberId === membre.id)
                    .reduce((sum, p) => sum + p.montant, 0);
                contributions[membre.id] = {
                    nom: `${membre.prenom} ${membre.nom}`,
                    total: total
                };
            });

            // Trier et prendre les top 5
            const top5 = Object.values(contributions)
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);

            window.chartInstances['top-contributeurs'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top5.map(c => c.nom),
                    datasets: [{
                        label: 'Total contribu√©',
                        data: top5.map(c => c.total),
                        backgroundColor: '#059669',
                        borderWidth: 1,
                        borderColor: '#047857'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value + ' FCFA';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>

    <!-- Modal pour afficher la carte en grand -->
    <div id="card-modal" class="card-modal">
        <div class="card-modal-content">
            <button class="card-modal-close" onclick="closeCardModal()">√ó</button>
            <div id="card-modal-body"></div>
        </div>
    </div>
    <!-- MODALE √âV√âNEMENTS -->
    <div id="evt-modal">
        <div class="evt-modal-content">
            <h3 style="margin-bottom:1rem; color:#059669;">√âditeur d'√âv√©nement</h3>
            <input type="hidden" id="evt-id">
            <div class="evt-form-group">
                <label style="font-weight:bold; display:block; margin-bottom:0.5rem;">Titre</label>
                <input type="text" id="evt-title" class="evt-input" placeholder="Ex: Magal, Rencontre...">
            </div>
            <div class="evt-form-group">
                <label style="font-weight:bold; display:block; margin-bottom:0.5rem;">Date</label>
                <input type="date" id="evt-date" class="evt-input">
            </div>
            <div class="evt-form-group">
                <label style="font-weight:bold; display:block; margin-bottom:0.5rem;">Description</label>
                <textarea id="evt-desc" class="evt-input" rows="3"></textarea>
            </div>
            <div class="evt-form-group">
                <label style="font-weight:bold; display:block; margin-bottom:0.5rem;">Cotisation (FCFA)</label>
                <input type="number" id="evt-fee" class="evt-input" placeholder="0" value="0">
            </div>
            <button class="evt-btn-primary" onclick="eventsModule.save()">Enregistrer</button>
            <button class="btn-secondary" style="width:100%; margin-top:0.5rem;"
                onclick="eventsModule.closeModal()">Annuler</button>
        </div>
    </div>

    <!-- Bottom Navigation Mobile -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showTab('membres', event)" data-tab="membres">
            <i class="fas fa-users"></i>
            <span>Membres</span>
        </button>
        <button class="nav-item" onclick="showTab('dashboard', event)" data-tab="dashboard">
            <i class="fas fa-chart-pie"></i>
            <span>Dashboard</span>
        </button>
        <button class="nav-item" onclick="showTab('paiements', event)" data-tab="paiements">
            <i class="fas fa-money-bill-wave"></i>
            <span>Adiya</span>
        </button>
        <button class="nav-item" onclick="showTab('stats', event)" data-tab="stats">
            <i class="fas fa-chart-bar"></i>
            <span>Stats</span>
        </button>
        <button class="nav-item" onclick="showTab('rapports', event)" data-tab="rapports">
            <i class="fas fa-file-alt"></i>
            <span>Rapports</span>
        </button>
        <button class="nav-item" onclick="showTab('depenses', event)" data-tab="depenses">
            <i class="fas fa-receipt"></i>
            <span>D√©penses</span>
        </button>
        <button class="nav-item" onclick="showTab('evenements', event)" data-tab="evenements">
            <i class="fas fa-calendar-alt"></i>
            <span>√âv√©nements</span>
        </button>
        <button class="nav-item" onclick="showTab('carte', event)" data-tab="carte">
            <i class="fas fa-id-card"></i>
            <span>Carte</span>
        </button>
        <button class="nav-item" onclick="showTab('calculateur', event)" data-tab="calculateur">
            <i class="fas fa-calculator"></i>
            <span>Calculateur</span>
        </button>
    </nav>

    <!-- Floating Action Button -->
    <button class="fab" onclick="openModal('addMember')" title="Ajouter un membre">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message"></span>
    </div>

</body>

</html>